function initializeAirport(e){(async()=>{for(;!window.hasOwnProperty("airports")||!window.hasOwnProperty("flights");)await new Promise(e=>setTimeout(e,10));null!=(airport=airports[e])&&($("#airport-icao").html(airport.icao),$("#airport-city").html(airport.city),$("#airport-name").html(airport.name)),el=document.getElementById("sidebar-container"),L.DomEvent.disableScrollPropagation(el),L.DomEvent.disableClickPropagation(el)})()}function zoomToAirport(a,e=0){$("#map").length&&!manual||(window.location.href="/?airport="+a),returnToView(),returnSidebarToView("airport-sidebar","control-airport-pullout"),$("#user-sidebar").hide(0),$("#user-sidebar").hide(0),$("#airport-sidebar").show(),"undefined"!=typeof ap_featuregroup&&map.hasLayer(ap_featuregroup)&&(map.removeLayer(ap_featuregroup),delete ap_featuregroup),ap_featuregroup=new L.FeatureGroup,initializeAirport(a),updateAirportFlights(airports,flights,a);var r=[];map.removeLayer(plane_featuregroup),$.each(flights,(e,t)=>{t.dep!=a&&t.arr!=a||(ap_featuregroup.addLayer(plane_array[e]),r.push([t.lat,t.lon]))}),console.log(r),map.addLayer(ap_featuregroup),e||map.fitBounds(r),$("#search-wrapper").hide(),window.history.pushState(a,a,"/?airport="+a)}function returnFromAirport(){"undefined"!=typeof ap_featuregroup&&(map.removeLayer(ap_featuregroup),delete ap_featuregroup),map.hasLayer(plane_featuregroup)||map.addLayer(plane_featuregroup),window.history.pushState("home","home","/"),$("#airport-sidebar").hide()}function updateAirportFlights(a,e,r){console.log("Updating Airports");var i=[],s=[];$.each(e,(e,t)=>{console.log(t.callsign+" "+t.dep+" "+t.arr),console.log(t.arr==r),console.log(r),t.arr==r?s.push(t):t.dep==r&&i.push(t)}),html="",depscount=0,arrscount=0,$.each(i,(e,t)=>{[airportname,airportcity]=getAirportDetails(a,t.arr),html=html+'<tr class="airport-list-item" onclick="zoomToFlight(\''+t.uid+'\')"><td class="px-2 py-2">'+t.callsign+'</td><td class="text-end pe-1"><small style="color: rgba(255,255,255,0.5)">to</small></td><td class="pe-1" style="vertical-align: middle; font-family: \'JetBrains Mono\', sans-serif;">'+t.arr+'</td><td style="vertical-align: middle">'+airportcity+"</td></tr>",depscount++}),$.each(s,(e,t)=>{[airportname,airportcity]=getAirportDetails(a,t.dep),html=html+'<tr class="airport-list-item" onclick="zoomToFlight(\''+t.uid+'\')"><td class="px-2 py-2">'+t.callsign+'</td><td class="text-end pe-1"><small style="color: rgba(255,255,255,0.5)">from</small></td><td class="pe-1" style="vertical-align: middle; font-family: \'JetBrains Mono\', sans-serif;">'+t.dep+'</td><td style="vertical-align: middle">'+airportcity+"</td></tr>",arrscount++}),$("#airport-list").html(html),$("#depcount").html(depscount),$("#arrcount").html(arrscount)}function getAirportLoad(a){var r=0;return $.each(flights,(e,t)=>{t.dep!=a&&t.arr!=a||r++}),r}function getAirportDetails(e,t){return null!=e[t]?returnvalue=[e[t].name,e[t].city]:(returnvalue=["Unknown Airport","Unknown City"],console.log("UNKNOWN: "+t)),returnvalue}function getAtisCode(e,a){return atis_exploded=e.replace("."," ").replace(","," ").toUpperCase().split(" "),delete code,$.each(atis_exploded,function(e,t){if("INFO"==t||"INFORMATION"==t||"ATIS"==t&&atis_exploded[e-1]==a&&"INFO"!=atis_exploded[e+1]&&"INFORMATION"!=atis_exploded[e+1])return code=atis_exploded[e+1],!1}),"undefined"==typeof code&&$.each(atis_exploded,function(e,t){if(t==a)return code=atis_exploded[e+1],!1}),"undefined"!=typeof code?1==code.length?code:convertToLetter(code):"-"}function convertToLetter(e){return void 0!==codes[e]?codes[e]:"-"}async function loadEvent(e){response=await fetchRetry(dataserver+"api/livedata/events/event"+e+".json"),eventdata=await response.json(),polyline_array=[],polyline_featuregroup=new L.FeatureGroup,map.addLayer(polyline_featuregroup),$("#event-name").html('<table style="flex: 1; border: 1px solid rgba(255,255,255,0.4); overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.6rem; overflow: hidden; font-weight: bold"><tr><td style="text-transform: uppercase; padding: 0 0.4rem; color: #c2737e; margin: 0.2rem">'+moment.utc(eventdata.event.start).format("MMM")+'</td></tr><tr><td style="font-size: 0.9rem; color: #eee; text-align: center">'+moment.utc(eventdata.event.start).format("D")+'</td></tr></table><span class="ps-2">'+eventdata.event.name+'<br><small style="font-size: 0.9rem; color: rgba(255,255,255,0.6">'+moment.utc(eventdata.event.start).format("HHmm")+"-"+moment.utc(eventdata.event.end).format("HHmm")+"Z </small></span>"),$("#event-date").html(moment(eventdata.event.start).format("MMMM Do, YYYY"));var a="",r={},t=(aar={},$.each(eventdata.event.airports,(e,t)=>{r[t.icao]=airportSearch(t.icao),aar[t.icao]={deps:[],arrs:[]},a+='<div class="badge bg-secondary me-1 mb-1" style="border-radius: 0.2rem; font-family: \'JetBrains Mono\'">'+t.icao+"</div>"}),$("#events-aps").html(a),$.each(eventdata.departures,(e,t)=>{1<t.logs.length&&(ll=[],$.each(t.logs,(e,t)=>{ll.push([t[0],t[1]])}),polyline=new L.Wrapped.Polyline(ll,{color:"#00cc66",opacity:.4,weight:2}),polyline_array[e]=polyline,polyline_featuregroup.addLayer(polyline_array[e])),t.accel&&t.dep&&didDepart(t,r)&&aar[t.dep].deps.push([t])}),$.each(eventdata.arrivals,(e,t)=>{1<t.logs.length&&(ll=[],$.each(t.logs,(e,t)=>{ll.push([t[0],t[1]])}),polyline=new L.Wrapped.Polyline(ll,{color:"#3366ff",opacity:.4,weight:2}),polyline_array[e]=polyline,polyline_featuregroup.addLayer(polyline_array[e])),t.decel&&t.arr&&didArrive(t,r)&&aar[t.arr].arrs.push([t])}),aarbins=[],"");start=moment(eventdata.event.start),end=moment(eventdata.event.end),0==start.minutes()?start.add(-60,"minutes"):start.startOf("hour"),0==end.minutes?end.add(60,"minutes"):end.add(60,"minutes").startOf("hour");for(var i=1e3*start.unix();i<1e3*end.unix();i+=18e5)(B={}).start=i,B.stop=i+1799999,aarbins.push(B);var s=0;for(y in aar){t+='<table class="events-e m-3" id="'+y+'"style="display: none;"><tr style="height: 100px">';var o=aar[y],n=[],l=[];for(v in aarbins){var c,d=aarbins[v],p=[],u=[];for(c in o.deps)(x=o.deps[c][0]).accel>d.start&&x.accel<d.stop&&p.push(x);for(c in o.arrs)(x=o.arrs[c][0]).decel>d.start&&x.decel<d.stop&&u.push(x);n.push(p),l.push(u)}for(v in aar[y].deps=n,aar[y].arrs=l,aar[y].deps)s<(p=aar[y].deps[v].length)+(u=aar[y].arrs[v].length)&&(s=p+u);for(v in aar[y].deps){var p=aar[y].deps[v].length;t+=0==v?'<td style="height: 100; min-width: 10px; position: relative; border-left: 1px dashed #999">':v%2==1?'<td style="height: 100; min-width: 10px; position: relative; border-right: 1px dashed #999">':'<td style="height: 100; min-width: 10px; position: relative; border-right: 1px solid transparent">',0<(u=aar[y].arrs[v].length)&&(t+='<div style="border: 1px solid #3366ff; position: absolute; left: 0; width: 100%; bottom: 0; height: '+u/s*100+'%"></div>'),0<p&&(t+='<div style="border: 1px solid #00cc66; position: absolute; left: 0; width: 100%; bottom: '+u/s*100+"%; height: "+p/s*100+'%"></div>'),t+="</td>"}for(v in t+='</tr><tr style="border-top: 1px solid #999">',aar[y].deps)t=t+(0==v?"<td style=\"font-family: 'JetBrains Mono', monospace;text-align: center; font-size: 0.7rem; min-width: 16px; position: relative; border-left: 1px dashed #999\">":v%2==1?"<td style=\"font-family: 'JetBrains Mono', monospace; text-align: center; font-size: 0.7rem; min-width: 16px; position: relative; border-right: 1px dashed #999\">":"<td style=\"font-family: 'JetBrains Mono', monospace;text-align: center; font-size: 0.7rem; min-width: 16px; position: relative; border-right: 1px solid transparent\">")+('<span style="color: #00cc66">'+(p=aar[y].deps[v].length)+'</span><br><span style="color: #3366ff;">'+(u=aar[y].arrs[v].length)+"</span></td>");for(v in t+="</tr><tr>",aarbins)v%2==0&&(t+=0==v?'<td colspan="2" style="color: #777; border-left: 1px dashed #999; border-right: 1px dashed #999; font-size: 0.8rem; font-family: \'JetBrains Mono\'; text-align: center">':'<td colspan="2" style="color: #777; border-right: 1px dashed #999; font-size: 0.8rem; font-family: \'JetBrains Mono\'; text-align: center">',moment(aarbins[v].start).hour()<10?t+="0"+moment(aarbins[v].start).hour()+"Z</td>":t+=moment(aarbins[v].start).hour()+"Z</td>");t+="</tr></table>"}$("#events-table").html(t),$(".analysis-button").attr("onclick","showAnalysis('"+eventdata.event.airports[0].icao+"'); $('#splitmodal').show();");var f=[];for(i in aar){var m=airportSearch(i),g=Number(m.lat),h=Number(m.lon),m=(f.push([g,h]),new L.divIcon({className:"simaware-ap-tooltip",html:getEventTooltipNew(m,aar),iconSize:"auto"}));oloc=new L.marker([g,h],{icon:m}),map.addLayer(oloc)}map.fitBounds(f,[50,50]),10<map.getZoom()&&map.setZoom(10);var y,b="",t="";for(y in aar){var v,w=aar[y],_=(Object.keys(aar)[0]==y?b+='<a id="'+y+'" onclick="showAnalysis(\''+y+'\')" class="analysis_chooser rounded-0 btn btn-sm text-white" style="border: 1px solid #393939; border-bottom: none; background-color: rgba(255,255,255,0.3)">'+y+"</a>":b+='<a id="'+y+'" onclick="showAnalysis(\''+y+'\')" class="analysis_chooser rounded-0 btn btn-sm text-white" style="border: 1px solid #393939; border-bottom: none;">'+y+"</a>",$("#analysis_airports").html(b),t+='<table class="aar" id="'+y+'">',[]);for(v in w.arrs){var x,B,A,C=w.arrs[v];for(c in C)(x=C[c]).landoffset&&didArrive(x,r)&&(B={},A=getEventOffset(x,r[y],eventdata,start),B.flight=x,B.lenpct=(x.landoffset-A)/(1e3*end.unix()-1e3*start.unix())*15e5,B.right=100*(1e3*end.unix()-x.decel)/(1e3*end.unix()-1e3*start.unix()),B.timeinMins=15e3*(x.landoffset-A)/6e4,_.push(B))}_.sort(function(e,t){return t.right-e.right}),aar[y].analysis=_}b="",t="";for(i in aar)b+='<a id="'+i+'" onclick="loadAnalysis(\''+i+'\')" class="analysis_chooser rounded-0 btn btn-outline-secondary text-white" style="border: 1px solid #393939; border-bottom: none;">'+i+"</a>";cycleEvents(0)}function showAnalysis(r){var e,t="",i=($(".analysis_chooser").each(function(){$(this).attr("id")==r?$(this).css({"background-color":"#3137fd"}):$(this).css({"background-color":"transparent"})}),"<tr>"),s=end.diff(start,"minutes");for(e in $.each(aarbins,(e,t)=>{var a=moment(t.start),t=moment(t.stop).diff(a,"minutes")/s*100;borderleft="dashed",borderright="dashed",i+='<td style="border-left: 1px '+borderleft+" #888; border-right: 1px "+borderright+" #888; vertical-align: middle; text-align: center; width: "+t+'%">ARR '+aar[r].arrs[e].length+"<br>DEP "+aar[r].deps[e].length}),i+="</tr>",console.log(i),$("#analysis_toptable").html(i),aar[r].analysis)0<aar[r].analysis[e].timeinMins&&(t+='<div style="width: 100%; height: 10px; font-size: 0.1rem; white-space: nowrap; text-align: right"><a href="#" class="px-1 badge text-white hover" data-toggle="tooltip" data-placement="right" title="'+aar[r].analysis[e].flight.callsign+" | "+Math.round(aar[r].analysis[e].timeinMins)+' min" style="z-index: 2; background-color: '+getFlightColor(aar[r].analysis[e].timeinMins)+"; margin-right: "+aar[r].analysis[e].right+"%; width: "+aar[r].analysis[e].lenpct+'%; height: 6px; border-radius: 0px">&nbsp;</a></div>');var o='<div class="mx-0" style="height: 100%; position: absolute; left: 0px; width: 100%; z-index: -1; overflow: hidden"><table style="width: 100%; color: #bbb; font-family: \'Roboto Mono\', monospace; font-size: 0.8rem; height: 100%">';console.log(aar[r]);for(let e=0;e<Math.ceil(aar[r].analysis.length)/20;e++)o+="<tr>",$.each(aarbins,(e,t)=>{console.log(t);var a=moment(t.start),t=moment(t.stop).diff(a,"minutes")/s*100;borderleft="dashed",borderright="dashed",o+='<td style="border-left: 1px '+borderleft+" #888; border-right: 1px "+borderright+" #888; vertical-align: middle;  height: 100px; text-align: left; width: "+t+'%"><div style="color: rgb(136, 136, 136); font-size: 0.9rem; font-family: \'Roboto Mono\', monospace; height: 60px; width: 60px;" class="rotate">'+a.format("HHmm")+" Z</div></td>"}),o+="</tr>";o+="</table></div>",$("#analysis").html(t+o),$('[data-toggle="tooltip"]').tooltip()}function getEventOffset(e,t,a,r){for(var i in e.logs){var s=e.logs[i];if(distance(t.lat,t.lon,s[0],s[1])<80)return i}}async function loadLegacyEvent(e){response=await fetch(apiserver+"api/event/"+e),eventdata=await response.json(),$("#event-name").html(eventdata.name),$("#event-date").html(moment(eventdata.start).format("MMMM Do, YYYY"));let a="";$.each(eventdata.airports.split(","),(e,t)=>{a+='<div class="badge bg-secondary me-1 mb-1" style="border-radius: 0.2rem; font-family: \'JetBrains Mono\'">'+t+"</div>"}),$("#events-aps").html(a),$("#events-table").html(returnEventsTable(eventdata.aarstore[0])),(1==Object.keys(eventdata.aarstore).length?replaceAarData:cycleLegacyEvents)(0),bounds=[],$.each(eventdata.aarstore,(e,t)=>{var a=Number(t.ap.lat),r=Number(t.ap.lon),t=(bounds.push([a,r]),new L.divIcon({className:"simaware-ap-tooltip",html:getEventTooltip(t),iconSize:"auto"}));oloc=new L.marker([a,r],{icon:t}),map.addLayer(oloc)}),map.fitBounds(bounds,[50,50]),1==bounds.length&&map.setZoom(8),response=await fetch(apiserver+"api/eventpaths/"+e),eventpaths=await response.json(),polyline_array=[],polyline_featuregroup=new L.FeatureGroup,map.addLayer(polyline_featuregroup),$.each(eventpaths,(e,t)=>{1<t.length&&(ll=[],$.each(t,(e,t)=>{ll.push([t[1],t[0]])}),polyline=new L.Wrapped.Polyline(ll,{color:"#fff",opacity:.2,weight:2}),polyline_array[e]=polyline,polyline_featuregroup.addLayer(polyline_array[e]))})}function getEventTooltip(e){let a=0;return $.each(e.aar,(e,t)=>{a+=t[2]}),'<div style="padding: 0.2rem; border-radius: 0.2rem; background-color: rgba(80,80,80,0.9); display: flex; flex-direction: column; justify-content: center;"><table style="align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-light" style="padding: 0px 5px">'+e.ap.icao+'</td></tr></table><table style="flex: 1; border-radius: 0.18rem; overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-white" style="background-color: #333; text-align: center; padding: 0px 5px">'+a+"</td></tr></table></div>"}function getEventTooltipNew(e){let t=0;for(var a in aar[e.icao].deps)t+=aar[e.icao].deps[a].length;for(var a in aar[e.icao].arrs)t+=aar[e.icao].arrs[a].length;return'<div style="padding: 0.2rem; border-radius: 0.2rem; background-color: rgba(80,80,80,0.9); display: flex; flex-direction: column; justify-content: center;"><table style="align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-light" style="padding: 0px 5px">'+e.icao+'</td></tr></table><table style="flex: 1; border-radius: 0.18rem; overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-white" style="background-color: #333; text-align: center; padding: 0px 5px">'+t+"</td></tr></table></div>"}function getWfTooltip(e){return'<div style="padding: 0.2rem; border-radius: 0.2rem; background-color: rgba(80,80,80,0.9); display: flex; flex-direction: column; justify-content: center;"><table style="align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-light" style="padding: 0px 5px">'+e.icao+'</td></tr></table><table style="flex: 1; border-radius: 0.18rem; overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td class="text-white" style="background-color: #333; text-align: center; padding: 0px 5px">'+getAirportLoad(e.icao)+"</td></tr></table></div>"}function cycleEvents(e){var t,a;e>=Object.keys(aar).length?cycleEvents(0):(a=airportSearch(t=Object.keys(aar)[e]),$("#event-ap").html("<b>"+a.icao+"</b> "+a.name+'<br /><span class="small text-muted">'+a.city+"</span>"),$(".events-e#"+t).fadeIn(300,function(){1<Object.keys(aar).length&&$(this).delay(5e3).fadeOut(150,function(){cycleEvents(e+1)})}))}function cycleLegacyEvents(e){e>=Object.keys(eventdata.aarstore).length?cycleLegacyEvents(0):(replaceAarData(e),$(".aarelement").each(function(){$(this).animate({opacity:1},300)}),$("#events-airport").animate({opacity:1},300,function(){$(".aarelement").each(function(){$(this).delay(5e3).animate({opacity:0},150)}),$(this).delay(5e3).animate({opacity:0},150,function(){cycleLegacyEvents(e+1)})}))}function returnEventsTable(e){for(element in ct=Object.keys(e.aar).length,text='<table class="m-2 text-white"><tr><td class="pb-2" colspan="'+(2*ct+1)+'"><div id="events-airport"><h6 class="mb-0"><b id="events-icao">&nbsp;</b> <span id="events-name"></span><br><small class="text-muted" id="events-city">&nbsp;</small></h6></div></td></tr><tr style="font-family: \'JetBrains Mono\'"><td><div style="width: 1px; height: 30px; background-color: #888; margin: 0 auto"></div></td>',e.aar)text+='<td style="min-width: 30px; text-align: center"><h5 class="mb-0 aarelement" id="aar'+element+'"></h5></td><td><div style="width: 1px; height: 30px; background-color: #888; margin: 0 auto"></div></td>';for(element in text+='</tr><tr style="font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem" class="text-muted" ><td style="text-align: center"><span><i class="fas fa-caret-up"></i></span><br>'+moment(e.aar[0][0].date).format("HHmm[Z]")+"</td>",e.aar)text+='<td></td><td style="text-align: center"><span><i class="fas fa-caret-up"></i></span><br>'+moment(e.aar[element][1].date).format("HHmm[Z]")+"</td>";return text+="</tr></table>"}function getCity(e){return city=e.ap.city==e.ap.country?e.ap.city:e.ap.state?e.ap.city+", "+e.ap.state:e.ap.city+", "+e.ap.country}function replaceAarData(e){$("#events-name").html(eventdata.aarstore[e].ap.name),$("#events-icao").html(eventdata.aarstore[e].ap.icao),$("#events-city").html(getCity(eventdata.aarstore[e])),$.each(eventdata.aarstore[e].aar,function(e,t){$("#aar"+e).html('<span style="color: '+getFlightColor(t[2])+'">'+t[2]+"</span>")})}async function loadUpcomingEvents(){var e=await fetch(dataserver+"api/livedata/events.json");events=await e.json();let r=[];return $.each(events.future,(e,a)=>{var t;0<=moment.duration(moment(a.start).diff(moment())).asDays()&&moment.duration(moment(a.start).diff(moment())).asDays()<14&&(t=a.airports,$.each(t,(e,t)=>{void 0!==r[t.icao]?r[t.icao].push(a):r[t.icao]=[a]}))}),r}function didDepart(e,t){for(var a in e.logs){a=e.logs[a];if(distance(a[0],a[1],t[e.dep].lat,t[e.dep].lon)<5)return!0}return!1}function didArrive(e,t){for(var a in e.logs){a=e.logs[a];if(distance(a[0],a[1],t[e.arr].lat,t[e.arr].lon)<5)return!0}return!1}async function initializeInfobar(){await initializePatrons(),await updateInfobar(),infobar_streamers()}async function updateInfobar(){await(await fetchRetry(dataserver+"api/livedata/vatsimdata.json")).json();al={},$.each(bnfoairports,e=>{al[e]=bnfoairports[e].departures+bnfoairports[e].arrivals});var e,t=[];for(e in al)t.push([e,al[e]]);t.sort(function(e,t){return t[1]-e[1]}),infoairports=[];var r='<h5 class="mb-3">Popular Airports</h5><table>';for(let e=0;e<10;e++){var a=airportSearch(bnfoairports[t[e][0]].icao);infoairports.push(bnfoairports[t[e][0]]),r+="<tr onclick=\"zoomToAirport('"+bnfoairports[t[e][0]].icao+'\')" ><td class="py-2"><span class="badge" style="color: #fff; border: 1px solid #fff; border-radius: 1rem; font-family: \'JetBrains Mono\', monospace">#'+(e+1)+'</span></td><td class="ps-3" style="font-family: \'JetBrains mono\', sans-serif">'+getLocalTooltip(bnfoairports[t[e][0]].icao)+'</td><td class="ps-3" style="font-size: 0.9rem; line-height: 0.9rem">'+a.name+'<br><small class="text-muted">'+a.city+'</small></td><td class="ps-3"><i class="fas fa-plane-departure"></i> '+bnfoairports[t[e][0]].departures+'</td><td class="ps-2"><i class="fas fa-plane-arrival"></i> '+bnfoairports[t[e][0]].arrivals+"</td></tr>"}r+="</table>",$("#ap-wrapper").html(r),r='<h5 class="mb-3">Upcoming Events</h5><table style="font-size: 0.9rem">',prevdate=null;let i=0,s=0;for(;s<10;){if(events.future[i].end>moment.now()){for(var o in r+='<tr><td class="py-1 pe-2"><div>',prevdate!=moment.utc(events.future[i].start).format("MMMD")&&(r+='<table style="flex: 1; overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.6rem; overflow: hidden; font-weight: bold"><tr><td style="text-transform: uppercase; padding: 0 0.4rem; color: #c2737e; margin: 0.2rem">'+moment.utc(events.future[i].start).format("MMM")+'</td></tr><tr><td style="font-size: 0.9rem; color: #eee; text-align: center">'+moment.utc(events.future[i].start).format("D")+"</td></tr></table>"),r+="</div></td>",moment.now()>events.future[i].start&&moment.now()<events.future[i].end?r+='<td class="ps-2 py-1 border-success" style="border-left: 2px solid;">':r+='<td class="ps-2 py-1">',r+=events.future[i].name+"<br><span style=\"color: rgba(255,255,255,0.8); font-size: 0.7rem; font-family: 'JetBrains Mono', monospace\">"+moment.utc(events.future[i].start).format("HHmm")+"-"+moment.utc(events.future[i].end).format("HHmm")+"Z ",events.future[i].airports)r+='<span class="text-muted">'+events.future[i].airports[o].icao+"</span> ";r+="</span></td></tr>",prevdate=moment.utc(events.future[i].start).format("MMMD"),s++}i++}r+="</table>",$("#events-wrapper").html(r),infostreamers={pilots:[],controllers:[]},r='<table style="font-size: 0.9rem"><h5 class="mb-3">Active Streamers</h5>',$.each(flights,(e,t)=>{var a;patrons[t.cid]&&(2<=patrons[t.cid].tier||!patrons[t.cid].tier)&&streamers[patrons[t.cid].twitch]&&((a={}).uid=e,a.dep=t.dep,a.arr=t.arr,a.dep||(a.dep="NONE"),a.arr||(a.arr="NONE"),a.streamername=patrons[t.cid].twitch,a.callsign=t.callsign,infostreamers.pilots.push(a),t=getStatus(e=plane_array[a.uid].flight),r+='<tr><td class="py-2"><a class="footer-infobar-item text-white"><i class="fab fa-twitch"></i> '+a.streamername+'</a></td><td class="ps-3">'+a.callsign+'</td><td class="ps-3">'+a.dep+'</td><td class="ps-2"><div class="d-flex flex-row align-items-center" style="width: 140px"><div id="infobar-flights-progressbar" class="d-flex flex-row align-items-center" style="flex-grow: 1"><div class="toggle-flights-progressbar-elapsed" id="'+a.uid+'" style="background-color: '+t.color+"; width: "+getInfoElapsedWidth(e)+'%"></div><i class="toggle-flights-progressbar-plane fas fa-plane" id="'+a.uid+'" style="color: '+t.color+'"></i><div class="toggle-flights-progressbar-remaining" id="'+a.uid+'"></div></td><td class="ps-2" style="text-align: right">'+a.arr+"</td></tr>")}),$.each(tracons,(e,t)=>{var a;patrons[t.cid]&&(2<=patrons[t.cid].tier||!patrons[t.cid].tier)&&streamers[patrons[t.cid].twitch]&&((a={}).cid=t.cid,a.name=t.name,a.streamername=patrons[t.cid].twitch,a.position=t.callsign,infostreamers.controllers.push(a),r+='<tr><td class="py-2"><i class="fab fa-twitch"></i> '+a.streamername+'</a></td><td colspan="4" class="ps-3">'+a.position+"</td></tr>")}),$.each(sectors,(e,t)=>{var a;patrons[t.cid]&&(2<=patrons[t.cid].tier||!patrons[t.cid].tier)&&streamers[patrons[t.cid].twitch]&&((a={}).cid=t.cid,a.name=t.name,a.streamername=patrons[t.cid].twitch,a.position=t.callsign,infostreamers.controllers.push(a),r+='<tr><td class="py-2"><i class="fab fa-twitch"></i> '+a.streamername+'</a></td><td colspan="4" class="ps-3">'+a.position+"</td></tr>")}),$.each(localsraw,(e,t)=>{var a;patrons[t.cid]&&(2<=patrons[t.cid].tier||!patrons[t.cid].tier)&&streamers[patrons[t.cid].twitch]&&!t.callsign.includes("_ATIS")&&((a={}).cid=t.cid,a.name=t.name,a.streamername=patrons[t.cid].twitch,a.position=t.callsign,infostreamers.controllers.push(a),r+='<tr><td class="py-2"><i class="fab fa-twitch"></i> '+a.streamername+'</a></td><td colspan="4" class="ps-3">'+a.position+"</td></tr>")}),r+="</table>",$("#streamers-wrapper").html(r)}function infobar_airports(){$("#infobar-title").html('<span class="badge bg-primary" style="font-size: 0.8rem; font-weight: normal; border-radius: 5rem; ">Popular Airports</span>'),$("#infobar-title").delay(500).fadeIn(250,()=>{infobar_airports_scroll(0)})}function infobar_airports_scroll(e,t=10){t<=e?$("#infobar-title").fadeOut(250,function(){infobar_streamers()}):(airport=airports[infoairports[e].icao],$("#infobar-content").html("<div onclick=\"zoomToAirport('"+infoairports[e].icao+'\')" class="px-3 footer-infobar-item d-flex align-items-center" style="min-height: 100%"><table class="text-white"><tr><td><span class="badge" style="color: #fff; border: 1px solid #fff; border-radius: 1rem; font-family: \'JetBrains Mono\', monospace">#'+(e+1)+'</span></td><td class="ps-3" style="font-family: \'JetBrains mono\', sans-serif">'+getLocalTooltip(infoairports[e].icao)+'</td><td class="ps-3" style="font-size: 0.9rem; line-height: 0.9rem">'+airport.name+'<br><small class="text-muted">'+airport.city+'</small></td><td class="ps-3"><i class="fas fa-plane-departure"></i> '+infoairports[e].departures+'</td><td class="ps-2"><i class="fas fa-plane-arrival"></i> '+infoairports[e].arrivals+"</td></tr></table></div>"),$("#infobar-content").delay(300).animate({left:"0px",opacity:1},250,"easeOutSine",()=>{$("#infobar-content").delay(5e3).animate({opacity:0},250,"easeOutSine",function(){$("#infobar-content").css({left:"-20px"}),infobar_airports_scroll(e+1)})}))}function infobar_streamers(){0==infostreamers.pilots.length&&0==infostreamers.controllers.length?infobar_airports():($("#infobar-title").html('<span class="badge bg-purple" style="font-size: 0.8rem; font-weight: normal; border-radius: 5rem">Streamers</span>'),$("#infobar-title").delay(500).fadeIn(250,()=>{infobar_streamers_scroll(0,"pilots")}))}function infobar_streamers_scroll(a,r){if(void 0===infostreamers[r]||void 0===infostreamers[r][a])"pilots"==r&&infobar_streamers_scroll(0,"controllers"),"controllers"==r&&$("#infobar-title").fadeOut(500,function(){infobar_airports()});else if("pilots"==r&&void 0!==plane_array[infostreamers[r][a].uid]){var i=plane_array[infostreamers[r][a].uid].flight,s=getStatus(i);let e=infostreamers[r][a].dep,t=infostreamers[r][a].arr;e=e||"NONE",t=t||"NONE";var o="https://twitch.tv/"+infostreamers[r][a].streamername;$("#infobar-content").html('<div class="d-flex" style="min-height: 100%"><div class="streamer px-3 d-flex align-items-center footer-infobar-item"><a class="text-white" href="'+o+'"><i class="fab fa-twitch"></i> '+infostreamers[r][a].streamername+"</a></div><div onmouseup=\"zoomToFlight('"+infostreamers[r][a].uid+'\')" class="pe-3 d-flex align-items-center footer-infobar-item"><table class="text-white" style="font-size: 0.9rem"><tr><td class="ps-3">'+infostreamers[r][a].callsign+'</td><td class="ps-3">'+e+'</td><td class="ps-2"><div class="d-flex flex-row align-items-center" style="width: 140px"><div id="infobar-flights-progressbar" class="d-flex flex-row align-items-center" style="flex-grow: 1"><div id="infobar-flights-progressbar-elapsed"></div><i id="infobar-flights-progressbar-plane" class="fas fa-plane"></i><div id="infobar-flights-progressbar-remaining"></div></td><td class="ps-2">'+t+"</td></tr></table></div></div>"),$("#infobar-flights-progressbar-plane").css({color:s.color}),$("#infobar-flights-progressbar-elapsed").css({"background-color":s.color}),$("#infobar-flights-progressbar-elapsed").css({width:getInfoElapsedWidth(i)+"%"}),$("#infobar-content").delay(300).animate({left:"0px",opacity:1},250,"easeOutSine",()=>{$("#infobar-content").delay(5e3).animate({opacity:0},250,"easeOutSine",function(){$("#infobar-content").css({left:"-20px"}),infobar_streamers_scroll(a+1,r)})})}else"controllers"==r?(o="twitch"==infostreamers[r][a].platform?"https://twitch.tv/"+infostreamers[r][a].streamername:"https://youtube.com/c/"+infostreamers[r][a].streamername+"/live",$("#infobar-content").html('<div class="d-flex" style="min-height: 100%"><div class="streamer px-3 d-flex align-items-center footer-infobar-item"><a class="text-white" href="'+o+'"><i class="fab fa-twitch"></i> '+infostreamers[r][a].streamername+'</a></div><div class="pe-3 d-flex align-items-center" style="min-height: 100%"><table class="text-white" style="font-size: 0.9rem"><tr><td style="vertical-align: middle" class="ps-3">'+infostreamers[r][a].position+"</td></tr></table></div></div>"),$("#infobar-content").delay(300).animate({left:"0px",opacity:1},250,"easeOutSine",()=>{$("#infobar-content").delay(5e3).animate({opacity:0},250,"easeOutSine",function(){$("#infobar-content").css({left:"-20px"}),infobar_streamers_scroll(a+1,r)})})):infobar_streamers_scroll(a+1,r)}codes={ALPHA:"A",BRAVO:"B",CHARLIE:"C",DELTA:"D",ECHO:"E",FOXTROT:"F",GOLF:"G",HOTEL:"H",INDIA:"I",JULIET:"J",KILO:"K",LIMA:"L",MIKE:"M",NOVEMBER:"N",OSCAR:"O",PAPA:"P",QUEBEC:"Q",ROMEO:"R",SIERRA:"S",TANGO:"T",UNIFORM:"U",VICTOR:"V",WHISKEY:"W",XRAY:"X",YANKEE:"Y",ZULU:"Z"},$(document).ready(()=>{$("#ap-toggle").on("click",()=>{$("#ap-wrapper").toggle(),$("#streamers-wrapper").hide(),$("#events-wrapper").hide(),$("#streamers-toggle").removeClass("toggle-item-active"),$("#events-toggle").removeClass("toggle-item-active"),$("#ap-wrapper").is(":visible")?$("#ap-toggle").addClass("toggle-item-active"):$("#ap-toggle").removeClass("toggle-item-active")}),$("#streamers-toggle").on("click",()=>{$("#streamers-wrapper").toggle(),$("#ap-wrapper").hide(),$("#events-wrapper").hide(),$("#streamers-wrapper").is(":visible")?$("#streamers-toggle").addClass("toggle-item-active"):$("#streamers-toggle").removeClass("toggle-item-active"),$("#events-toggle").removeClass("toggle-item-active"),$("#ap-toggle").removeClass("toggle-item-active")}),$("#events-toggle").on("click",()=>{$("#events-wrapper").toggle(),$("#ap-wrapper").hide(),$("#streamers-wrapper").hide(),$("#events--toggle").removeClass("toggle-item-active"),$("#events-wrapper").is(":visible")?$("#events-toggle").addClass("toggle-item-active"):$("#events-toggle").removeClass("toggle-item-active"),$("#events-toggle").addClass("toggle-item-active"),$("#ap-toggle").removeClass("toggle-item-active")})}),apiserver="https://api.simaware.ca/",dataserver="https://data.simaware.ca/";const warnings={NAT0:"Oceanic clearance required for entry.  See ganderoceanic.ca for more information.",CZQO0:"Oceanic clearance required for entry.  See ganderoceanic.ca for more information.",EGGX0:"Oceanic clearance required for entry.  See ganderoceanic.ca for more information."},wf=["YSSY","YMML","YWKS","SCGC","SAWH","SAVC","SUMU","SBBR","SBEG","TNCC","MMUN","MMGL","KIAH","KATL","KBOS","CYWG","LPPD","GMMN","DAAG","LPFR","LIMC","LFQQ","EGFF","ELLX","ESGG","EVRA","UKBB","LLBG","HEGN","ORBI","OBBI","OOMS","VOHS","VEPT","VGHS","ZULS","ZLLL","ZUTF","RCTP","VHHH","VTBS","WIMM","WIDD","WAHI","YPDN","YBCS","YBBN","YSSY"];function initializeMap(e=0,t=0){$(".os-host-flexbox").overlayScrollbars({}),plane_array=[],active_uids=[],active_firs=[],active_tracons=[],tracons_array=[],tracmarkers_array=[],icons_array=[],firs_array=[],firmarkers_array=[],sigmets_array=[],sigmarkers_array=[],active_flight=null,initializeIcons(),$.cookie("init")||$("#disclaimer").removeClass("d-none").addClass("d-flex"),initializeFirData();var t=t?"active-area-landscape":"active-area";$("#map").length&&((map=L.map("map",{zoomControl:!1,preferCanvas:!0,zoomSnap:.15}).setView([30,0],3).setActiveArea(t)).doubleClickZoom.disable(),basemap=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a> | <a href="https://github.com/maiuswong/simaware-express"><i class="fab fa-github"></i> SimAware on GitHub</a> | <b>Not for real-world navigation.</b>',subdomains:"abcd"}).addTo(map),map.attributionControl.setPosition("topright"),L.control.ruler({position:"topleft",lengthUnit:{factor:.539956803,display:"nm",label:"Distance:",decimal:2},circleMarker:{color:"#00d700",radius:2},lineStyle:{color:"#00d700",dashArray:"1,6"}}).addTo(map),$.cookie("mapView")&&(t=JSON.parse($.cookie("mapView")),map.setView([t.lat,t.lng],t.zoom,!0)),$.each(["controls","flights-sidebar","search-field","user-sidebar","footer-background","streamers-bar"],(e,t)=>{(el=document.getElementById(t))&&(L.DomEvent.disableClickPropagation(el),L.DomEvent.disableScrollPropagation(el))}),map.on("moveend",function(e){var t={lat:map.getCenter().lat,lng:map.getCenter().lng,zoom:map.getZoom()};$.cookie("mapView",JSON.stringify(t))}),map.on("click",function(){map.hasLayer(active_featuregroup)&&returnToView(),$("#search-wrapper").hide()}),$("#search-field").click(()=>{$("#search-wrapper").show();var e=$("#search-field").val().toLowerCase();$("#search-results").html(compileSearchResults(e))})),plane_featuregroup=new L.FeatureGroup,e||map.addLayer(plane_featuregroup),atc_featuregroup=new L.FeatureGroup,active_featuregroup=new L.FeatureGroup,tracons_featuregroup=new L.FeatureGroup,locals_featuregroup=new L.FeatureGroup,sigmets_featuregroup=new L.FeatureGroup,events_featuregroup=new L.FeatureGroup,nats_featuregroup=new L.FeatureGroup,wf_featuregroup=new L.FeatureGroup}function initializeIcons(){$.each(["B739"],function(e,t){icons_array[t]=new L.divIcon({className:t,iconSize:[18,18],iconAnchor:[9,9]})})}function initializeWorldFlight(){$.each(wf,(e,t)=>{0<e&&(e=airports[wf[e-1]])&&airports[t]&&(e=20<getAirportLoad(e.icao)?new L.Wrapped.Polyline([[e.lat,e.lon],[airports[t].lat,airports[t].lon]],{color:"#ffcc33",weight:5,opacity:1,nowrap:!0}):new L.Wrapped.Polyline([[e.lat,e.lon],[airports[t].lat,airports[t].lon]],{color:"#fff",weight:5,opacity:.5,nowrap:!0}),wf_featuregroup.addLayer(e));e=new L.divIcon({className:"simaware-ap-tooltip",html:getWfTooltip(airports[t]),iconSize:"auto"}),t=new L.marker([airports[t].lat,airports[t].lon],{icon:e});wf_featuregroup.addLayer(t)})}function returnSidebarToView(e,t){var a;a=576<$("#map").width()?"1rem":($("#map").width()-350)/2+"px",el=$("#"+e).animate({right:a},250,"easeOutSine"),$("#"+t).hide()}function getBadge(e){var t="";switch(e){case 1:t="PPL";break;case 3:t="IFR";break;case 7:t="CMEL";break;case 15:t="ATPL"}return t.length?'<span style="font-size: 0.8rem; font-weight: normal; color: #fff" class="me-2 px-2 badge badge-sm bg-warning">'+t+"</span>":""}function initializeAirports(){airportsByIata=[],airportsByPrefix=[],$.getJSON(dataserver+"api/livedata/airports.json",function(e){airports=e,$.each(airports,(e,t)=>{(airportsByIata[t.iata]=t).prefix&&(airportsByPrefix[t.prefix]=t)})})}async function initializeFirData(){let e=await fetchRetry(dataserver+"api/livedata/countries.json");countries=await e.json(),e=await fetchRetry(dataserver+"api/livedata/firs.json"),firs=await e.json(),e=await fetchRetry(dataserver+"api/livedata/uirs.json"),uirs=await e.json()}function getAirline(e){if(e.callsign.match(/[A-Z]+/)&&void 0!==airlines[e.callsign.match(/[A-Z]+/)[0]])return airlines[e.callsign.match(/[A-Z]+/)[0]]}async function initializeNexrad(){response=await fetchRetry("https://tilecache.rainviewer.com/api/maps.json"),data=await response.json(),ts=data[0],nexrad=L.tileLayer("https://tilecache.rainviewer.com/v2/radar/"+ts+"/512/{z}/{x}/{y}/6/0_1.png",{tileSize:256,opacity:.4})}async function initializePatrons(){response=await fetchRetry(dataserver+"api/livedata/patrons.json"),ret=await response.json(),patrons={},$.each(ret,e=>{ret[e].cid&&(patrons[ret[e].cid]=ret[e])}),response=await fetchRetry(dataserver+"api/livedata/streamers.json"),streamers=await response.json()}function initializeATC(){$.ajax({url:"/livedata/firboundaries.json",xhrFields:{withCredentials:!1},success:function(e){firmap=new L.geoJSON(e,{style:{fillColor:"#fff",fillOpacity:0,weight:1,color:"#333"}}),$.each(firmap._layers,function(e,t){var e=firmap.getLayer(e),a=t.feature.properties.oceanic,t=t.feature.properties.id;void 0===firs_array[t+a]?firs_array[t+a]=[e]:firs_array[t+a].push(e)}),atc_featuregroup.addLayer(firmap)}}),$.ajax({url:"/livedata/traconboundaries.json",xhrFields:{withCredentials:!1},success:function(e){traconmap=new L.geoJSON(e,{style:{fillColor:"#fff",fillOpacity:0,weight:.01,color:"#222"}}),$.each(traconmap._layers,function(e,t){var r=traconmap.getLayer(e),e=t.feature.properties.prefix,i=void 0===t.feature.properties.suffix||null===t.feature.properties.suffix?"APP":t.feature.properties.suffix;$.each(e,(e,t)=>{var a;null!=tracons_array[t]?tracons_array[t][i]=r:((a=[])[i]=r,tracons_array[t]=a)})}),atc_featuregroup.addLayer(traconmap),atc_featuregroup.addLayer(tracons_featuregroup)}})}async function refreshFlights(e=null,t=null){try{response=await fetchRetry(dataserver+"api/livedata/live.json",{credentials:"omit"}),flights=await response.json()}catch(e){return}for(var a in flights=applyFilter(flights,e,t),bnfoairports={},newactive_uids=[],$.each(flights,function(e,t){(void 0!==plane_array[t.uid]?updateLocation:addAircraft)(t),(t.dep||t.arr)&&(bnfoairports[t.dep]?bnfoairports[t.dep].departures++:bnfoairports[t.dep]={icao:t.dep,departures:1,arrivals:0},bnfoairports[t.arr]?bnfoairports[t.arr].arrivals++:bnfoairports[t.arr]={icao:t.arr,departures:0,arrivals:1})}),plane_array)newactive_uids.includes(a)||(plane_featuregroup.removeLayer(plane_array[a]),delete plane_array[a]);return active_flight&&updateFlightsBox(flights[active_flight]),active_uids=newactive_uids,$("#navbar-pilots").html(Object.keys(plane_array).length),flights}function interpolateLoc(){for(uid in plane_array){var e=plane_array[uid].getLatLng(),t=6378.1,a=Math.PI*plane_array[uid].flight.hdg/180,r=1.852*plane_array[uid].flight.gndspd/3600*1,i=Math.PI*e.lat/180,e=Math.PI*e.lng/180,s=180*Math.asin(Math.sin(i)*Math.cos(r/t)+Math.cos(i)*Math.sin(r/t)*Math.cos(a))/Math.PI,e=180*(e+Math.atan2(Math.sin(a)*Math.sin(r/t)*Math.cos(i),Math.cos(r/t)-Math.sin(i)*Math.sin(s)))/Math.PI;plane_array[uid].setLatLng(new L.LatLng(s,e))}}function applyFilter(e,a=null,r=null){var i={};return a?($.each(e,(e,t)=>{switch(a){case"airport":t.dep!=r&&t.arr!=r||(i[t.uid]=t);case"fleet":0==t.callsign.indexOf(r)&&(i[t.uid]=t)}}),i):e}function addAircraft(e){var t=createPlaneMarker(e);plane_array[t.uid]=t,plane_featuregroup.addLayer(plane_array[t.uid]),markUID(e)}function createPlaneMarker(e){new Image;var t=getMarker(e.aircraft),t=L.canvasMarker(new L.LatLng(e.lat,e.lon),{radius:16,img:{url:"/img/aircraft/"+t[2]+".png",size:[1.2*Math.pow(t[0],.75),1.2*Math.pow(t[1],.75)],rotate:["BALL"].includes(e.aircraft)?0:e.hdg,offset:{x:0,y:0}}});return t.uid=e.uid,t.flight=e,[offset,dir]=getMarkerDirection(e),t.bindTooltip(getDatablock(e),{offset:offset,direction:dir,permanent:!1,className:"datablock"}),t.on("click",function(e){L.DomEvent.stopPropagation(e),zoomToFlight(this.uid)}),t}function getDatablock(e){return'<span class="datablock">'+e.callsign+" "+e.aircraft+"<br>"+100*Math.round(Number(e.alt)/100)+" "+e.gndspd+"<br>"+e.dep+" "+e.arr+"</span>"}function updateLocation(e){try{plane_array[e.uid].setLatLng(new L.LatLng(Number(e.lat),Number(e.lon))),plane_array[e.uid].options.img.rotate=["BALL"].includes(e.aircraft)?0:e.hdg,plane_array[e.uid]._update()}catch(e){}plane_array[e.uid].setTooltipContent(getDatablock(e)),plane_array[e.uid].flight=e,"undefined"!=typeof flightpath&&active_featuregroup.hasLayer(flightpath)&&plane.flight.uid==e.uid&&flightpath.addLatLng([e.lat,e.lon]),markUID(e)}function getMarkerDirection(e){return dir=Number(e.hdg)<180?(offset=L.point(5,12),"right"):(offset=L.point(-5,12),"left"),[offset,dir]}function markUID(e){0<=$.inArray(e,active_uids)&&active_uids.splice(active_uids.indexOf(e.uid),1),newactive_uids.push(e.uid)}function markFIR(e){0<=$.inArray(e,active_firs)&&active_firs.splice(active_firs.indexOf(e),1)}function airportSearch(e){return airportsByPrefix[e]||airports[e]||airportsByIata[e]||void 0}function getActiveFIRs(){var e,t=[];for(e in firs_array)"#fff"==firs_array[e][0].options.color&&t.push(e);return t}function lightUpTracon(e,t){var a,r,i=tracons_array[t.split("|")[0]][t.split("|")[1]];i.setStyle({weight:1.5,color:"#40e0d0"}),void 0===tracmarkers_array[t]&&(a=new L.divIcon({className:"simaware-ap-tooltip",html:getTracTooltip(i.feature.properties.id,t),iconSize:"auto"}),r=getTraconMarkerLoc(i),tracmarkers_array[t]=new L.marker(r,{icon:a}),tracmarkers_array[t].bindTooltip(getTraconBlock(e,"DEP"==t.slice(-3)),{opacity:1,sticky:!0}),atc_featuregroup.addLayer(tracmarkers_array[t]),i.bringToFront())}function traconSearch(e){e.replace("__","_");var t=e.slice(0,-4),a=e.slice(-3);return void 0!==tracons_array[t]&&void 0!==tracons_array[t][a]?[tracons_array[t][a],"bounds",t+"|"+a]:void 0!==tracons_array[t]&&void 0!==tracons_array[t].APP?[tracons_array[t].APP,"bounds",t+"|APP"]:void 0!==airportsByIata[t]?[airportsByIata[t],"circles",t]:void 0!==airports[t]?[airports[t],"circles",t]:(t=e.split("_")[0],void 0!==tracons_array[t]&&void 0!==tracons_array[t][a]?[tracons_array[t][a],"bounds",t+"|"+a]:void 0!==tracons_array[t]&&void 0!==tracons_array[t].APP?[tracons_array[t].APP,"bounds",t+"|APP"]:void 0!==airportsByIata[t]?[airportsByIata[t],"circles",t]:void 0!==airports[t]?[airports[t],"circles",t]:null)}function groupTracons(e){return(traconsGrouped=[]).bounds=[],traconsGrouped.circles=[],$.each(e,(e,t)=>{var a;(foundTracon=traconSearch(t.callsign))&&(null==traconsGrouped[foundTracon[1]][foundTracon[2]]?((a=[]).loc=foundTracon[2],a.members=[t],"circles"==foundTracon[1]?(a.airport=foundTracon[0],a.name="Unknown City"==foundTracon[0].city?foundTracon[0].name:foundTracon[0].city.split(",")[0]+" Approach"):a.name=foundTracon[0].feature.properties.name,traconsGrouped[foundTracon[1]][foundTracon[2]]=a):traconsGrouped[foundTracon[1]][foundTracon[2]].members.push(t))}),traconsGrouped}function firSearch(e){t=0<=e.search("_FSS")?"FSS":"CTR";var t,e=e.replace("__","_").replace("_CTR","").replace("_FSS","");if("FSS"==t){if(void 0!==uirs[e])return uirs[e];if(void 0!==uirs[e.split("_")[0]])return uirs[e.split("_")[0]]}return void 0!==firs[e]?firs[e]:void 0!==firs[e.split("_")[0]]?firs[e.split("_")[0]]:void 0!==uirs[e]?uirs[e]:void 0!==uirs[e.split("_")[0]]?uirs[e.split("_")[0]]:void 0}function getCallsign(e){var t,a;return void 0!==(t=void 0!==uirs[e]?uirs[e]:firSearch(e))?void 0!==t.firs?t.name:(a=getCountry(t))&&""!=a.radar?t.name+" "+a.radar:a&&"USA"==a.name?t.name+" Center":e.search("_FSS")?t.name+" Radio":t.name+" Centre":null}function getTraconMarkerLoc(e){var t=polylabel(e.feature.geometry.coordinates[0],1),a=[];return $.each(e.getLatLngs()[0][0],(e,t)=>{a.push(t.lat)}),[Math.max(...a),t[1]]}function getCallsignByFir(e,t){var a;return null==t&&(t=e.icao+"0"),null!=e?"CZUL"==e.icao?"Centre de Montr√©al":void 0!==e.firs||0<e.name.search("Oceanic")||0<e.name.search("Radar")||0<e.name.search("Control")||0<e.name.search("Centre")?e.name:(a=getCountry(e),"1"==t[t.length-1]?e.name+" Radio":a&&""!=a.radar?e.name+" "+a.radar:a&&"USA"==a.name?e.name+" Center":e.name+" Centre"):"Unknown Position"}function getTimeOnline(e,t=1){t=t?moment.unix(e.created_at_timestamp):moment(e.created_at+"+0000"),e=Math.abs(moment().diff(t,"minutes",!1));let a=e%60;return Math.floor(e/60).toString()+":"+(a=(a=a.toString()).length<2?"0"+a:a)}function getCountry(e){return void 0!==countries[e.icao.substring(0,2)]?countries[e.icao.substring(0,2)]:null}async function refreshATC(){active_firs=getActiveFIRs(),newdata={};var s=0;try{e=await fetchRetry(dataserver+"api/livedata/onlinefirs.json"),sectors=await e.json(),s+=sectors.length}catch(e){return}$.each(sectors,(e,t)=>{var a,r,i=firSearch(t.callsign);i&&void 0===i.firs&&(a=getFirIndexByCallsign(t.callsign),t.time_online=getTimeOnline(t),void 0===newdata[a]?((r={}).firname=getCallsignByFir(i,a),r.members=[t],r.firicao=i.icao,r.firObj=firs_array[a],newdata[a]=r):newdata[a].members.push(t),s++)}),$.each(sectors,(e,i)=>{var t=firSearch(i.callsign);i.time_online=getTimeOnline(i),t&&void 0!==t.firs&&(i.fssname=t.name,i.fssicao=t.prefix,$.each(t.firs,(e,t)=>{var a,r=getFirIndexByCallsign(t);void 0===newdata[r]?((a={}).firname=getCallsignByFir(firSearch(t),r),a.members=[i],a.firicao=t,a.firObj=firs_array[r],newdata[r]=a):newdata[r].members.push(i),s++}))}),$.each(newdata,(e,t)=>{var a,r,i;1<t.firname.search("Oceanic")&&(a=t.firObj,r=t.firname,i=t.firicao,lightupFIR(a,t.members,r,i,e),markFIR(e))}),$.each(newdata,(e,t)=>{var a,r,i;-1==t.firname.search("Oceanic")&&(a=t.firObj,r=t.firname,i=t.firicao,lightupFIR(a,t.members,r,i,e),markFIR(e))}),$.each(active_firs,(e,t)=>{turnOffFIR(firObj=firs_array[t],t)});try{var e=await fetchRetry(dataserver+"api/livedata/appdep.json");tracons=await e.json(),s+=tracons.length}catch(e){return}"undefined"!=typeof tracons_circles_featuregroup&&tracons_featuregroup.hasLayer(tracons_circles_featuregroup)&&tracons_featuregroup.removeLayer(tracons_circles_featuregroup),tracons_circles_featuregroup=new L.FeatureGroup;var t=[];for(traconid in(traconsGrouped=groupTracons(tracons)).bounds){var a=traconsGrouped.bounds[traconid];0<=$.inArray(traconid,active_tracons)?(active_tracons.splice(active_tracons.indexOf(traconid),1),tracmarkers_array[traconid].setTooltipContent(getTraconBlock(a))):lightUpTracon(a,traconid),t.push(traconid)}for(traconid in $.each(active_tracons,(e,t)=>{turnOffTracon(t)}),traconsGrouped.circles){trac=traconsGrouped.circles[traconid];var r=new L.circle([trac.airport.lat,trac.airport.lon],{radius:6e4,weight:1.25,fillOpacity:0,color:"#40e0d0"});r.bindTooltip(getTraconBlock(trac),{opacity:1}),tracons_circles_featuregroup.addLayer(r)}active_tracons=t,tracons_featuregroup.addLayer(tracons_circles_featuregroup);try{e=await fetchRetry(dataserver+"api/livedata/locals.json"),localsraw=await e.json()}catch(e){return}for(id in $.each(localsraw,function(e,t){t.callsign.includes("_ATIS")||s++}),locals=[],$.each(localsraw,(e,t)=>{var a=t.callsign.replace("__","_").split("_"),r=a[0],a=a[a.length-1],r=airportSearch(r);void 0!==r&&(void 0===locals[r.icao]?((obj={}).loc=r,obj[a]=[t],locals[r.icao]=obj):void 0!==locals[r.icao][a]?locals[r.icao][a].push(t):locals[r.icao][a]=[t])}),atc_featuregroup.hasLayer(locals_featuregroup)&&(atc_featuregroup.removeLayer(locals_featuregroup),locals_featuregroup=new L.FeatureGroup),locals){var i=locals[id],o=Number(i.loc.lat),n=Number(i.loc.lon),l=new L.divIcon({className:"simaware-ap-tooltip",html:getLocalTooltip(i.loc.icao),iconSize:"auto"});(oloc=new L.marker([o,n],{icon:l})).bindTooltip(getLocalBlock(i.loc.icao),{opacity:1,sticky:!0}),locals_featuregroup.addLayer(oloc)}for(icao in eventsByAirport)void 0===locals[icao]&&airports[icao]&&(o=airports[icao].lat,n=airports[icao].lon,l=new L.divIcon({className:"simaware-ap-tooltip",html:getLocalTooltip(icao),iconSize:"auto"}),(oloc=new L.marker([o,n],{icon:l})).bindTooltip(getLocalBlock(icao),{opacity:1,sticky:!0}),locals_featuregroup.addLayer(oloc));atc_featuregroup.addLayer(locals_featuregroup),$("#navbar-atc").html(s)}async function updateSigmet(){for(var e in response=await fetchRetry(dataserver+"api/livedata/sigmets.json"),data=await response.json(),sigmets_array)sigmets_featuregroup.removeLayer(sigmets_array[e]),sigmets_featuregroup.removeLayer(sigmarkers_array[e]);$.each(data.AIRSIGMET,(e,t)=>{if("CONVECTIVE"==t.hazard["@attributes"].type){let a=[],r=[];var i,s=getSigmetCode(t);$.each(t.area.point,(e,t)=>{a.push([Number(t.latitude),Number(t.longitude)]),r.push([Number(t.longitude),Number(t.latitude)])}),""!=s&&(sigmets_array[s]=new L.Polygon(a,{color:"#ffcc33",weight:1.5}),i=new L.divIcon({className:"simaware-ap-tooltip",html:'<div style="position: relative"><div style="position: absolute; top: -8px; right: -25%; font-family: \'Roboto Mono\'"><span onmouseenter="highlightSigmet(\''+s+"')\" onmouseleave=\"dehighlightSigmet('"+s+'\')" style="color: #fc3">'+s+"</span></div></div>",iconSize:"auto"}),sigmets_featuregroup.addLayer(sigmets_array[s]),sigmarkers_array[s]=new L.marker(polylabel([r],1),{icon:i}),sigmarkers_array[s].bindTooltip(getSigmetBlock(t),{opacity:.9}),sigmets_featuregroup.addLayer(sigmarkers_array[s]))}})}function getSigmetBlock(e){return list='<div class="card bg-dark text-white"><div class="card-header ps-2" style="background-color: #efa31d"><h5 class="mb-0" style="color: #fff">Convective SIGMET '+getSigmetCode(e)+'</h5></div><div class="p-2"><small style="font-family: \'JetBrains Mono\', sans-serif; font-size: 0.65rem; color: #aaa">'+nl2br(e.raw_text)+"</div></div>"}function getSigmetCode(e){return e.raw_text.split(/\r?\n/)[2].split(" ")[2]}function lightupFIR(e,a,r,i,s){if("object"==typeof e){var t=[];for(idx in e){e[idx].setStyle({color:"#fff",weight:1.5,fillColor:"#fff",fillOpacity:.1}),latlng=[Number(e[idx].feature.properties.label_lat),Number(e[idx].feature.properties.label_lon)];var o=new L.divIcon({className:"simaware-ap-tooltip",html:getFirTooltip(i,s,a),iconSize:"auto"});void 0===firmarkers_array[s]?(t[idx]=new L.marker(latlng,{icon:o}),t[idx].bindTooltip(getControllerBlock(e[idx],a,r,i,s),{opacity:1,sticky:!0})):$.each(firmarkers_array[s],(e,t)=>{t.setTooltipContent(getControllerBlock(t[idx],a,r,i,s))}),e[idx].bringToFront()}if(void 0===firmarkers_array[s])for(idx in firmarkers_array[s]=t,firmarkers_array[s])atc_featuregroup.addLayer(firmarkers_array[s][idx])}}function turnOffFIR(e,a){"object"==typeof e&&$.each(e,function(e,t){for(e in t.setStyle({color:"#333",weight:1,fillOpacity:0}).bringToBack(),firmarkers_array[a])atc_featuregroup.removeLayer(firmarkers_array[a][e]);firmarkers_array[a]=void 0})}function turnOffTracon(e){tracons_array[e.split("|")[0]][e.split("|")[1]].setStyle({weight:0,color:"#000"}),atc_featuregroup.removeLayer(tracmarkers_array[e]),tracmarkers_array[e]=void 0}function getFirIndex(e){var t=e.fir.icao+Number(e.fir.is_fss);return t=void 0===firs_array[t]?e.fir.icao+"0":t}function getFirIndexByCallsign(e){t=0<e.search("_FSS")?1:0;var t,e=firSearch(e);if(null!=e){if(void 0!==firs_array[e.icao+t])return e.icao+t;if(void 0!==firs_array[e.icao+"0"])return e.icao+"0"}return null}function getLocalColor(e){return e.TWR?red:e.GND?green:e.DEL?blue:e.ATIS?yellow:"#999"}function getFirTooltip(e,t,a){var r=0,i="",a=($.each(a,function(e,t){t.fssname&&0==r?(r=1,i=t.fssicao):r=0}),'<div style="position: relative"><div class="firlabel" onmouseenter="highlightFIR(\''+t+"')\" onmouseleave=\"dehighlightFIR('"+t+'\')" style="position: relative; display: flex; flex-direction: column; justify-content: center;"><table style="margin: 0.2rem; align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.75rem; overflow: hidden; font-weight: bold"><tr><td class="text-light" style="padding: 0px 5px; white-space: nowrap; text-align: center">'+e);return r&&(a+='<br><span class="rounded px-1" style="background-color: #9370db">'+i+"</span>"),a+="</td></tr></table></div></div>"}function getTracTooltip(e,t){return'<div style="position: relative"><div class="traclabel" onmouseenter="highlightTracon(\''+t+"')\" onmouseleave=\"dehighlightTracon('"+t+'\')" style="position: relative; display: flex; flex-direction: column; justify-content: center;"><table style="margin: 0.2rem; align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem; overflow: hidden; font-weight: bold"><tr><td style="color: #40e0d0; padding: 0px 5px; white-space: nowrap; text-align: center">'+e+"</td></tr></table></div></div>"}function highlightFIR(e){$.each(firs_array[e],(e,t)=>{t.setStyle({fillColor:"#fff",fillOpacity:.4})})}function dehighlightFIR(e){$.each(firs_array[e],(e,t)=>{t.setStyle({fillOpacity:.1})})}function highlightTracon(e){var t=e.split("|");for(idx in tracons_array[t[0]])idx==t[1]&&tracons_array[t[0]][t[1]].setStyle({fillColor:"#40d0e0",fillOpacity:.2})}function dehighlightTracon(e){var t=e.split("|");for(idx in tracons_array[t[0]])idx==t[1]&&tracons_array[t[0]][t[1]].setStyle({fillOpacity:0})}function highlightSigmet(e){sigmets_array[e].setStyle({fillOpacity:.4})}function dehighlightSigmet(e){sigmets_array[e].setStyle({fillOpacity:.1})}function getLocalTooltip(t){var e;locals[t]?e=locals[t]:((e=[]).loc=[],e.loc.icao=t),ct=0,s="";let a="text-white-50",r="rgba(0,0,0,0)",i=(e.DEL&&(s+='<td class="text-white" style="background-color: '+blue+'; text-align: center; padding: 0px 5px">D</td>',ct+=1),e.GND&&(s+='<td class="text-white" style="background-color: '+green+'; text-align: center; padding: 0px 5px">G</td>',ct+=1),e.TWR&&(s+='<td class="text-white" style="background-color: '+red+'; text-align: center; padding: 0px 5px">T</td>',ct+=1),e.ATIS&&(s+='<td class="text-white" style="background-color: '+yellow+'; text-align: center; padding: 0px 5px">A</td>',ct+=1),""!=s&&(s="<table style=\"margin: 0.2rem; margin-top: 0rem; flex: 1; overflow: hidden; font-family: 'JetBrains Mono', sans-serif; font-size: 0.6rem; overflow: hidden; font-weight: bold\"><tr>"+s+"</tr></table>",a="text-light",r="rgba(255,255,255,0.1)"),"");if(eventsByAirport[t]){for(id in days_rem=999,eventsByAirport[t])i=eventsByAirport[t][id],days_rem=Math.min(moment.duration(moment(i.start).diff(moment())).asDays(),days_rem);let e="";e=days_rem<1?"background-color: "+red:days_rem<7?"border: 2px solid rgba(218,41,46,0.5);background-color: rgba(0,0,0,0.5)":"border: 2px solid rgba(218,41,46,0.25);background-color: rgba(0,0,0,0.25)",i='<div style="position: absolute; top: -5px; left: -5px; border-radius: 5px; width: 10px; height: 10px; '+e+'"></div>'}var s="<div ondblclick=\"zoomToAirport('"+t+'\', true)" style="position: relative; background-color: '+r+'; display: flex; flex-direction: column; justify-content: center;">'+i+'<table style="margin: 0.2rem; align-self: center; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.6rem; overflow: hidden; font-weight: bold"><tr><td colspan="'+ct+'" class="'+a+'" style="padding: 0px 5px">'+e.loc.icao+"</td></tr></table>"+s+"</div>";return s}function getLocalBlock(a){void 0!==airports[a]&&(city=airports[a].city),void 0!==locals[a]?e=locals[a]:(e=[]).loc=airports[a],ct=0,tt="";var e,r='<table style="width: 100%; color: #eee; font-size: 0.9rem"><tr><td colspan="6" class="pb-1" style="font-size: 1rem; font-weight: 400; white-space: nowrap"><p class="mb-0">'+e.loc.name+'</p><small class="text-muted mt-0" style="font-size: 0.8rem">'+city+"</small></td></tr>";if(e.DEL&&$.each(e.DEL,(e,t)=>{r+='<tr><td style="display: flex; flex-direction: column"><div class="badge" style="background-color: '+blue+"; margin-right: 0.4rem; font-family: 'JetBrains Mono', sans-serif;\">DEL</div></td><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; white-space: nowrap\">"+t.callsign+'</td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+getTimeOnline(t)+"</td></tr>"}),e.GND&&$.each(e.GND,(e,t)=>{r+='<tr><td style="display: flex; flex-direction: column"><div class="badge" style="background-color: '+green+"; margin-right: 0.4rem; font-family: 'JetBrains Mono', sans-serif;\">GND</div></td><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; white-space: nowrap\">"+t.callsign+'</td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+getTimeOnline(t)+"</td></tr>"}),e.TWR&&$.each(e.TWR,(e,t)=>{r+='<tr><td style="display: flex; flex-direction: column"><div class="badge" style="background-color: '+red+"; margin-right: 0.4rem; font-family: 'JetBrains Mono', sans-serif;\">TWR</div></td><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; white-space: nowrap\">"+t.callsign+'</td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+getTimeOnline(t)+"</td></tr>"}),e.ATIS&&$.each(e.ATIS,(e,t)=>{r+='<tr><td rowspan="2" style="vertical-align:top"><div style="display: flex; flex-direction: column"><div class="badge" style="background-color: '+yellow+'; border-bottom-left-radius: 0; border-bottom-right-radius: 0; margin-right: 0.4rem; font-family: \'JetBrains Mono\', sans-serif;">ATIS</div><div class="badge" style="background-color: #181818; border-top-left-radius: 0; border-top-right-radius: 0; font-size: 1.6rem; margin-right: 0.4rem; font-family: \'JetBrains Mono\', sans-serif;"">'+getAtisCode(t.atis,a)+"</div></div></td><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; white-space: nowrap\">"+t.callsign+'</td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+getTimeOnline(t)+'</td></tr><tr><td colspan="4" style="color: #ccc; font-family: \'JetBrains Mono\', sans-serif; font-size: 0.7rem">'+t.atis+"</td></tr>"}),eventslist="",eventsByAirport[a])for(id in eventslist='<tr><td colspan="2" style="position: relative"><div style="position: absolute; top: 50%; left: 0; right: 0; height: 1; background-color: #999; z-index: 0"></div><small class="px-1" style="position: absolute; top: 0; left: 20; z-index: 1; background-color: #282828; color: #999">Upcoming Events</small><small>&nbsp;</small></td></tr>',eventsByAirport[a])eventslist+='<tr><td class="pe-3 pt-1" width="15%"><table class="rounded-2" style="overflow: hidden; font-family: \'JetBrains Mono\', sans-serif; background-color: #eee"><tr><td style="color: rgb(169,56,72); text-transform: uppercase; font-size: 0.6rem; text-align: center">'+moment(eventsByAirport[a][id].start).format("MMM")+'</td></tr><tr><td style="min-width: 35px; text-align: center; font-size: 1rem; color: #222">'+moment(eventsByAirport[a][id].start).format("D")+'</td></tr></table></td><td style="font-size: 0.9rem; white-space: nowrap">'+eventsByAirport[a][id].name+'<br><small class="text-muted" style="font-family: \'JetBrains Mono\', sans-serif">'+moment(eventsByAirport[a][id].start).format("HHmm")+" - "+moment(eventsByAirport[a][id].end).format("HHmm")+"Z</small></td></tr>";return r='<div class="card border border-secondary" style="background-color: #282828; min-width: 300px; overflow: hidden"><div class="p-2">'+r+"</table></div>",eventsByAirport[a]&&(r+='<div class="p-2 pt-0" style="background-color: #282828"><table style="width: 100%">'+eventslist+"</table></div>"),r+="</div>"}function getNatBlock(e){var a="",e=($.each(e.route,(e,t)=>{0!=e&&(a+=' <i class="fas fa-angle-right"></i> '),a+=t.name}),'<table style="width: 300px; color: #ccc" class="mb-2"><tr><td style="width: 60px; border: 1px solid #ccc; text-align: center; font-size: 0.9rem"><h1 style="font-weight: bold; font-family: \'JetBrains Mono\', sans-serif;" class="mb-0">'+e.id+'</h1></td><td rowspan="2" class="px-2"><small style="font-weight: bold">North Atlantic Track</small><hr class="my-1"><span style="font-family: \'JetBrains Mono\', sans-serif; font-size: 0.9rem">'+a+'</span></td></tr><tr><td style="border: 1px solid #ccc; text-align: center"><small>TMI '+e.tmi+"</small>");return'<div class="card" style="background-color: #282828; border: 1px solid #ccc"><div class="p-2" style="font-size: 1rem; font-weight: bold">'+(e+="</td></tr></table>")+'<small class="text-muted mb-0" style="font-weight: normal">Data courtesy of Gander Oceanic OCA</small></div></div>'}function getControllerBlock(e,t,a,r,i){var s='<table style="width: 100%; color: #333; font-size: 0.9rem"><tr><td colspan="4" style="font-size: 1rem; font-weight: 600; white-space: nowrap"><span class="text-muted">'+r+"</span> "+a+"</td></tr>";return warnings[i]&&(s+='<tr><td colspan="3" class="small text-muted pt-0"><i class="fas fa-info-circle"></i> '+warnings[i]+"</td></tr>"),$.each(t,function(e,t){s=t.fssname?(s=s+"<tr><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; color: #9370DB; white-space: nowrap\">"+t.callsign+'<i style="display: inline; color: #9370db" class="ms-1 fas fa-caret-square-down"></i></td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.time_online+"</td></tr>")+'<tr><td colspan="4" class="small text-muted pt-0" style="line-height: 0.9rem;"><b style="color: #9370db">'+t.fssname+"</b> covers "+r+" above FL245</td></tr>":s+"<tr><td style=\"vertical-align: middle; font-family: 'JetBrains Mono', sans-serif; white-space: nowrap\">"+t.callsign+'</td><td class="px-3" style="vertical-align: middle; text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.time_online+"</td></tr>"}),s='<div class="card"><div class="p-2" style="color: #222; background-color: #eee">'+s+"</table></div></div>"}function getTraconBlock(e,t=0){return tracon_name=e.name,list='<table style="width: 100%; color: #333; font-size: 0.9rem"><tr><td colspan="3" style="font-size: 1rem; font-weight: 600">'+tracon_name+"</td></tr>",$.each(e.members,function(e,t){list=list+"<tr><td style=\"font-family: 'JetBrains Mono', sans-serif\">"+t.callsign+'</td><td class="px-3" style="text-align: right; white-space: nowrap;">'+t.name+'</td><td class="text-primary" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+t.freq+'</td><td class="text-muted" style="font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem"></td><td class="ps-3 text-muted" style="vertical-align: middle; font-family: \'JetBrains Mono\', monospace; letter-spacing: -0.05rem">'+getTimeOnline(t)+"</td></tr>"}),list='<div class="card"><div class="p-2" style="color: #222; background-color: #eee">'+list+"</table></div></div>"}async function loadAirlines(){return response=await fetchRetry("/livedata/airlines.json"),airlines=await response.json(),airlinesByIcao={},$.each(airlines,(e,t)=>{airlinesByIcao[t.icao]=t}),airlinesByIcao}async function loadRegprefixes(){return(response=await fetchRetry("/livedata/regprefixes.json")).json()}async function loadAircraft(){return response=await fetchRetry("/livedata/aircraft.json"),aircraft=await response.json(),aircraftByIcao={},$.each(aircraft,(e,t)=>{aircraftByIcao[t.icao]=t}),aircraftByIcao}async function initializeNat(){}async function zoomToFlight(e){$("#map").length||(window.location.href="/?uid="+e),$("#streamers-bar").is(":visible")&&$("#streamers-bar").addClass("d-none").removeClass("d-flex"),historical=void 0===plane_array[e]?1:0,"undefined"!=typeof plane&&(active_featuregroup.removeLayer(plane),delete plane),"undefined"!=typeof dep_point&&(active_featuregroup.removeLayer(dep_point),delete dep_point),"undefined"!=typeof arr_point&&(active_featuregroup.removeLayer(arr_point),delete arr_point),"undefined"!=typeof flightpath&&(active_featuregroup.removeLayer(flightpath),delete flightpath),historical?(response=await fetchRetry(apiserver+"api/flight/"+e),planedata=await response.json(),bounds=[planedata.flight.lat,planedata.flight.lon],(plane=createPlaneMarker(planedata.flight)).flight.historical=!0):(plane=plane_array[e],(bounds=[]).push(plane.getLatLng())),active_flight=e,historical||refreshFlights(filterName,filterCriteria),$("#search-wrapper").hide(),"undefined"!=typeof ap_featuregroup&&$("#airport-sidebar").hide(),"undefined"!=typeof user_sidebar&&user_sidebar&&$("#user-sidebar").hide(),$("#events-container").hide(),[dep_airport,dep_point,dep_name,dep_city]=processAirport(plane.flight.dep),[arr_airport,arr_point,arr_name,arr_city]=processAirport(plane.flight.arr),dep_point&&arr_point&&([dep_point,arr_point]=processAirportForAntimeridian(plane.flight,airports[dep_airport],airports[arr_airport],dep_point,arr_point)),dep_point&&null!=dep_point&&(active_featuregroup.addLayer(dep_point),bounds.push(dep_point.getLatLng())),arr_point&&null!=arr_point&&(active_featuregroup.addLayer(arr_point),bounds.push(arr_point.getLatLng())),map.addLayer(active_featuregroup),"undefined"!=typeof ap_featuregroup&&map.hasLayer(ap_featuregroup)?map.removeLayer(ap_featuregroup):map.removeLayer(plane_featuregroup),"undefined"!=typeof polyline_featuregroup&&map.hasLayer(polyline_featuregroup)&&map.removeLayer(polyline_featuregroup),active_featuregroup.addLayer(plane),plane.bringToFront(),togglePlaneTooltip(plane,!0),$("#flights-sidebar").show().addClass("d-flex"),updateFlightsBox(plane.flight),$("#sidebar").hide(),historical?(flightpath=await new L.Polyline(adjustLogsForAntimeridian(planedata.flight,airports[dep_airport],airports[arr_airport],planedata.logs),{smoothFactor:1,color:"#00D300",weight:1,nowrap:!0}),await active_featuregroup.addLayer(flightpath)):await(addedFlightPathPromise=addFlightPath(dataserver+"api/livedata/logs/"+e+".json",airports[dep_airport],airports[arr_airport],plane.flight)),window.history.pushState(e,e,"/?uid="+e)}async function addFlightPath(e,t,a,r){e=await(await fetchRetry(e)).json();flightpath=await new L.Polyline(adjustLogsForAntimeridian(r,t,a,e),{smoothFactor:1,color:"#00D300",weight:1.5,nowrap:!0}),await active_featuregroup.addLayer(flightpath)}function toggleStreamers(){$(".map-button#streamers").hasClass("map-button-active")?($("#streamers-bar").removeClass("d-flex").addClass("d-none"),$(".map-button#streamers").removeClass("map-button-active")):($("#streamers-bar").removeClass("d-none").addClass("d-flex"),$(".map-button#streamers").addClass("map-button-active"))}function toggleWorldflight(){map.hasLayer(wf_featuregroup)?($(".map-button#wf").removeClass("map-button-active"),map.removeLayer(wf_featuregroup)):($(".map-button#wf").addClass("map-button-active"),map.addLayer(wf_featuregroup))}function toggleLabels(){"undefined"==typeof locLabels?(locLabels=("undefined"==typeof basemap?L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19}):L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/dark_only_labels/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})).addTo(map),$(".map-button#labels").addClass("map-button-active"),$.cookie("labels","true",{expires:180})):(map.removeLayer(locLabels),delete locLabels,$(".map-button#labels").removeClass("map-button-active"),$.cookie("labels","false",{expires:180}))}function flipLabels(e){map.removeLayer(locLabels),locLabels=("dark"==e?L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/dark_only_labels/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19}):L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',subdomains:"abcd",maxZoom:19})).addTo(map)}function toggleBasemap(){"undefined"==typeof basemap?(map.removeLayer(lightbasemap),basemap=L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}{r}.png",{attribution:"",subdomains:"abcd"}).addTo(map),$(".map-button#light").removeClass("map-button-active"),setLayerOrder(),setBasemapOrder(),lightbasemap=void 0,$.cookie("lightmap","false",{expires:180}),map.hasLayer(locLabels)&&flipLabels("dark")):(map.removeLayer(basemap),lightbasemap=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:""}).addTo(map),$(".map-button#light").addClass("map-button-active"),setLayerOrder(),setBasemapOrder(),basemap=void 0,$.cookie("lightmap","true"),"undefined"!=typeof locLabels&&map.hasLayer(locLabels)&&flipLabels("light"))}function togglePlaneTooltip(e,t){e.unbindTooltip(),[offset,dir]=getMarkerDirection(e.flight),e.bindTooltip(getDatablock(e.flight),{permanent:t,direction:dir,offset:offset})}function processAirport(e){var t=airports[e]?((t=L.circleMarker(new L.LatLng(airports[e].lat,airports[e].lon),{radius:2,stroke:!1,fillColor:"#00d300",fillOpacity:1})).bindTooltip(airports[e].iata,{permanent:!0,className:"tooltip-airport"}),[e,t,airports[e].name,airports[e].city]):[e,null,"Unknown Airport","Unknown City"];return t}function getColor(e){return e<80?"text-success":e<100?"text-warning":"text-danger"}function getFlightColor(e){1<(e=(e-15)/35)?e=1:e<0&&(e=0);var t=1-2*e,e=((r=-t)<0&&(r=0),t<0&&(t=0),1-2*Math.abs(e-.5)),a=r+t+e,r=r/a,a=(t/=a,e/=a,[255,77,77]),i=[51,204,51],s=[255,179,26];return"rgb("+Math.floor(r*a[0]+t*i[0]+e*s[0])+","+Math.floor(r*a[1]+t*i[1]+e*s[1])+","+Math.floor(r*a[2]+t*i[2]+e*s[2])+")"}async function returnToView(){map.hasLayer(active_featuregroup)&&(togglePlaneTooltip(plane,!1),plane.flight.historical||plane_featuregroup.addLayer(plane),map.removeLayer(active_featuregroup),manual||("undefined"!=typeof ap_featuregroup?(map.addLayer(ap_featuregroup),$("#airport-sidebar").show()):map.addLayer(plane_featuregroup),"undefined"!=typeof user_sidebar&&user_sidebar&&$("#user-sidebar").show()),delete active_featuregroup,active_featuregroup=new L.FeatureGroup,$("#flights-sidebar").hide().removeClass("d-flex"),$("#sidebar").show(),$("#events-container").show(),$(".map-button#streamers").hasClass("map-button-active")&&$("#streamers-bar").addClass("d-flex").removeClass("d-none"),active_flight=null),"undefined"!=typeof polyline_featuregroup&&map.addLayer(polyline_featuregroup),window.history.pushState("home","home","/")}function handleCookies(){"true"==$.cookie("atc")&&toggleATC(),"true"==$.cookie("lightmap")&&toggleBasemap(),"true"==$.cookie("sigmet")&&toggleSigmet(),"true"==$.cookie("nat")&&toggleNat(),"true"==$.cookie("wx")&&toggleNexrad(),"true"==$.cookie("labels")&&toggleLabels(),$(".map-button").removeClass("d-none"),$(".loading").addClass("d-none")}function updateFlightsBox(e){$("#flights-callsign").html(e.callsign),flight_status=getStatus(e),$(".flights-liveitem#spd").html(e.gndspd+" kt"),$(".flights-liveitem#alt").html(e.alt+" ft"),$(".flights-liveitem#togo").html(Math.round(getDtg(e))+" nm"),$("#flights-status").html(flight_status.status),$("#flights-status").css({"background-color":flight_status.color}),$("#flights-progressbar-plane").css({color:flight_status.color}),$("#flights-progressbar-elapsed").css({"background-color":flight_status.color}),flight_status.blink?$("#flights-progressbar-plane").addClass("blinking"):$("#flights-progressbar-plane").removeClass("blinking"),updateAirlines(e);var t=getTimeAirborne(e);"nodep"!=t.status?($("#flights-airborne-container").addClass("d-flex").removeClass("d-none"),hrstring=1==t.timeonline[0]?t.timeonline[0]+" hour, ":t.timeonline[0]+" hours, ",mnstring=1==t.timeonline[1]?t.timeonline[1]+" minute":t.timeonline[1]+" minutes",timestring=0==t.timeonline[0]?mnstring:hrstring+mnstring,$("#flights-timeairborne").addClass("mt-2").html("Time Airborne: "+timestring)):($("#flights-airborne-container").addClass("d-none").removeClass("d-flex"),$("#flights-timeairborne").removeClass("mt-2").html("")),[dep_airport,dep_point_,dep_name,dep_city]=processAirport(plane.flight.dep),[arr_airport,arr_point_,arr_name,arr_city]=processAirport(plane.flight.arr),$("#flights-dep-icao").html('<div class="flights-link-item" onclick="zoomToAirport(\''+dep_airport+"')\">"+dep_airport+"</div>"),$("#flights-airport-dep").html('<div class="flights-link-item" onclick="zoomToAirport(\''+dep_airport+"')\">"+dep_name+'<br><span class="text-muted">'+dep_city+"</span></div>"),$("#flights-arr-icao").html('<div class="flights-link-item" onclick="zoomToAirport(\''+arr_airport+"')\">"+arr_airport+"</div>"),$("#flights-airport-arr").html('<div class="flights-link-item" onclick="zoomToAirport(\''+arr_airport+"')\">"+arr_name+'<br><span class="text-muted">'+arr_city+"</span></div>"),$("#flights-progressbar-elapsed").css({width:getElapsedWidth(e)+"%"}),$("#flights-route").html(e.route),$("#flights-equipment").html(e.aircraft),$("#flights-name").html('<span class="me-2">'+e.name+"</span>"+getBadge(e.rating)+" "+getPatron(e.cid)),$("#flights-squawk").html(e.xpdr+" / "+e.axpdr)}function updateAirlines(e){for(i in regprefixes)if(e.callsign.match(regprefixes[i].regex))return void $("#flights-airline").html("Privately Registered ("+regprefixes[i].country+")");var t;3<e.callsign.length&&$.isNumeric(e.callsign[3])&&airlinesByIcao&&airlinesByIcao[e.callsign.substring(0,3)]?(t=airlinesByIcao[e.callsign.substring(0,3)],$("#flights-airline").html(t.name)):$("#flights-airline").html("")}function getPatron(e){if(!patrons[e])return"";switch(patrons[e].tier){case 1:return'<span style="font-size: 0.8rem; font-weight: normal; background-color: #FF424D; color: #fff; border-radius: 1rem;" class="px-2 badge badge-sm"><i class="fab fa-patreon"></i> Supporter</span>';case 2:return'<span style="font-size: 0.8rem; font-weight: normal; background-color: #FF424D; color: #fff; border-radius: 1rem;" class="px-2 badge badge-sm"><i class="fab fa-patreon"></i> Streamer</span>';default:return""}}function processAirportForAntimeridian(e,t,a,r,i){return crossesAntimeridian(t,a)&&(dep_latlon=r.getLatLng(),arr_latlon=i.getLatLng(),0<Number(e.lon)&&(Number(arr_latlon.lng)<0&&(arr_latlon.lng+=360),Number(dep_latlon.lng)<0)&&(dep_latlon.lng+=360),Number(e.lon)<0&&(0<Number(arr_latlon.lng)&&(arr_latlon.lng-=360),0<Number(dep_latlon.lng))&&(dep_latlon.lng-=360),r.setLatLng(dep_latlon),i.setLatLng(arr_latlon)),[r,i]}function crossesAntimeridian(e,t){return flag=0,null==e||null==t?0:(Number(t.lon)<Number(e.lon)&&getRhumbLineBearing(Number(e.lat),Number(e.lon),Number(t.lat),Number(t.lon))<180?flag=1:Number(t.lon)>Number(e.lon)&&180<=getRhumbLineBearing(Number(e.lat),Number(e.lon),Number(t.lat),Number(t.lon))&&(flag=-1),flag)}function adjustLogsForAntimeridian(a,e,t,r){return newLogs=[],crossesAntimeridian(e,t)?(newLogs=[],$.each(r,function(e,t){lat=Number(t[0]),lon=Number(a.lon)<0&&0<Number(t[1])?Number(t[1])-360:0<Number(a.lon)&&Number(t[1])<0?Number(t[1])+360:Number(t[1]),newLogs.push([lat,lon])})):newLogs=r,newLogs}async function toggleATC(){map.hasLayer(atc_featuregroup)?(map.removeLayer(atc_featuregroup),$(".map-button#atc").removeClass("map-button-active"),$.cookie("atc","false",{expires:180})):(map.addLayer(atc_featuregroup),await refreshATC(),setLayerOrder(),$(".map-button#atc").addClass("map-button-active"),$.cookie("atc","true",{expires:180}))}function setBasemapOrder(){"undefined"!=typeof locLabels&&map.hasLayer(locLabels)&&locLabels.bringToFront(),map.hasLayer(nexrad)&&nexrad.bringToFront()}function setLayerOrder(){$("#map").length&&(map.hasLayer(sigmets_featuregroup)&&sigmets_featuregroup.bringToFront(),map.hasLayer(nats_featuregroup)&&nats_featuregroup.bringToFront(),map.hasLayer(plane_featuregroup)?plane_featuregroup.bringToFront():map.hasLayer(active_featuregroup)&&active_featuregroup.bringToFront())}function toggleNexrad(){map.hasLayer(nexrad)?(map.removeLayer(nexrad),$(".map-button#wx").removeClass("map-button-active"),$.cookie("wx","false",{expires:180})):(map.addLayer(nexrad),$(".map-button#wx").addClass("map-button-active"),$.cookie("wx","true",{expires:180}))}function toggleSigmet(){map.hasLayer(sigmets_featuregroup)?(map.removeLayer(sigmets_featuregroup),$(".map-button#sigmet").removeClass("map-button-active"),setLayerOrder(),$.cookie("sigmet","false",{expires:180})):(map.addLayer(sigmets_featuregroup),$(".map-button#sigmet").addClass("map-button-active"),setLayerOrder(),$.cookie("sigmet","true",{expires:180}))}function toggleNat(){map.hasLayer(nats_featuregroup)?(map.removeLayer(nats_featuregroup),$(".map-button#nat").removeClass("map-button-active"),setLayerOrder(),$.cookie("nat","false",{expires:180})):(map.addLayer(nats_featuregroup),$(".map-button#nat").addClass("map-button-active"),setLayerOrder(),$.cookie("nat","true",{expires:180}))}function getAircraftIcao(e){return 3<=(ac=e.split("/")).length?ac[1]:ac[0]}function getMarker(e){switch(ac=getAircraftIcao(e)){case"A3ST":return[45,56,"A3ST"];case"A30B":case"A306":return[45,54,"A300"];case"A310":return[44,47,"A310"];case"A318":return[34,32,"A318"];case"A319":case"A19N":return[34,34,"A319"];case"A320":case"A20N":return[36,40,"A320"];case"A321":case"A21N":return[36,47,"A321"];case"A332":return[60,59,"A332"];case"A333":case"A338":case"A339":return[60,64,"A333"];case"A342":return[60,60,"A342"];case"A343":return[60,64,"A343"];case"A345":return[63,67,"A345"];case"A346":return[63,74,"A346"];case"A359":return[65,62,"A359"];case"A35K":return[65,69,"A35K"];case"A388":return[80,74,"A388"];case"B703":return[44,47,"B703"];case"B720":return[40,41,"B720"];case"B712":return[28,38,"B712"];case"B721":return[33,41,"B721"];case"B722":return[33,46,"B722"];case"B731":return[28,28,"B731"];case"B732":return[28,31,"B732"];case"B733":return[29,34,"B733"];case"B734":return[29,37,"B734"];case"B735":return[29,32,"B735"];case"B736":return[35,33,"B736"];case"B737":return[35,35,"B737"];case"B738":return[35,41,"B738"];case"B739":return[35,43,"B739"];case"B74S":return[60,70,"B74S"];case"B741":return[60,70,"B741"];case"B742":return[60,70,"B742"];case"B743":return[60,70,"B743"];case"B744":return[64,70,"B744"];case"B748":return[68,76,"B748"];case"BCLF":return[64,72,"BCLF"];case"B752":return[38,47,"B752"];case"B753":return[38,54,"B753"];case"B762":return[48,52,"B762"];case"B763":return[48,58,"B763"];case"B764":return[52,61,"B764"];case"B772":return[60,64,"B772"];case"B773":return[60,74,"B773"];case"B77L":return[64,64,"B77L"];case"B77W":return[65,74,"B77W"];case"B788":return[60,57,"B788"];case"B789":return[60,63,"B789"];case"B78X":return[60,66,"B78X"];case"CONC":return[26,60,"CONC"];case"A124":return[73,69,"A124"];case"A225":return[88,83,"A225"];case"AT43":case"AT44":case"AT45":case"AT46":return[30,28,"AT4x"];case"AT72":case"AT73":case"AT75":case"AT76":return[32,32,"AT7x"];case"B461":case"B462":case"B463":case"RJ70":case"RJ85":case"RJ1H":return[28,33,"B46x"];case"BA11":return[33,33,"BA11"];case"BALL":return[73,100,"BALL"];case"BN2P":return[28,20,"BN2P"];case"C25C":return[28,30,"C25C"];case"C152":return[26,19,"C152"];case"C172":return[28,21,"C172"];case"C700":return[27,27,"C700"];case"COMT":return[34,35,"COMT"];case"DA40":return[28,19,"DA40"];case"DA42":return[28,18,"DA42"];case"DA62":return[30,19,"DA62"];case"DC6":return[36,31,"DC6"];case"DC10":return[50,55,"DC10"];case"DH8A":case"DH8B":return[30,27,"DH8A"];case"DH8C":case"DH8D":return[28,33,"DH8D"];case"DHC6":return[28,22,"DHC6"];case"E170":case"E175":return[28,33,"E17x"];case"E190":case"E195":return[27,36,"E19x"];case"E290":case"E295":return[36,39,"E29x"];case"E75S":case"E75L":return[31,32,"E75x"];case"E120":return[27,28,"E120"];case"E135":case"E145":return[24,31,"E135"];case"EC35":case"EC45":return[27,27,"EC45"];case"EUFI":return[21,30,"EUFI"];case"F22":return[22,30,"F22"];case"GLID":return[38,19,"GLID"];case"L101":return[50,50,"L101"];case"MD82":case"MD83":case"MD88":case"MD90":return[32,45,"MD8x"];case"MD11":return[51,61,"MD11"];case"PA28A":case"PA28B":case"PA28R":case"PA28S":case"PA28T":case"PA28U":return[28,22,"PA28x"];case"SB20":return[27,30,"SB20"];case"SB34":return[29,27,"SB34"];case"SF50":return[28,21,"SF50"];case"SR22":case"S22T":return[28,20,"SR22"];case"T154":return[37,48,"T154"];case"TBM9":return[28,23,"TBM9"];case"VC10":return[48,41,"VC10"];case"VISC":return[28,24,"VISC"];case"A748":return[31,22,"A748"];case"BCS1":return[35,35,"BCS1"];case"BCS3":return[39,34,"BCS3"];case"CP10":return[28,24,"CP10"];case"JS41":return[27,28,"JS41"];case"BE58":return[28,22,"BE58"];case"BR31":return[43,36,"BR31"];case"SH36":return[28,27,"SH36"];case"TRI":return[30,35,"TRI"];case"ME08":return[28,22,"ME08"];case"DC86":return[43,57,"DC86"];case"CL60":return[33,35,"CL60"];case"F18":case"F18":return[20,30,"F18"];case"F35":return[21,30,"F35"];case"R22":return[14,37,"R22"];case"R44":return[12,43,"R44"];case"R66":return[20,40,"R66"];case"F15":return[21,30,"F15"];case"F16":return[19,30,"F16"];case"U2":return[36,25,"U2"];case"SR71":return[19,37,"SR71"];case"C130":return[40,27,"C130"];case"B06":return[12,40,"B06"];case"B407":return[21,30,"B407"];case"V22":return[30,20,"V22"];case"ATP":return[31,28,"ATP"];case"H160":return[29,34,"H160"];case"B37M":return[36,36,"B37M"];case"B38M":return[36,39,"B38M"];case"B39M":return[36,42,"B39M"];case"B3XM":return[36,44,"B3XM"];case"C510":return[29,28,"C510"];case"C750":return[28,33,"C750"];case"C17":return[52,53,"C17"];case"DC3":return[30,21,"DC3"];case"A400":return[42,46,"A400"];case"CRJ1":return[24,30,"CRJ1"];case"CRJ7":return[25,35,"CRJ7"];case"CRJ9":return[25,38,"CRJ9"];case"CRJX":return[27,40,"CRJX"];case"C208":return[28,20,"C208"];case"E55P":return[28,28,"E55P"];case"PC12":return[28,23,"PC12"];case"GLEX":return[34,35,"GLEX"];case"GLF5":return[31,32,"GLF5"];case"FA50":return[31,30,"FA50"];case"TBM8":return[28,24,"TBM8"];case"H47":return[24,35,"H47"];case"DHC7":return[34,30,"DHC7"];case"RFAL":return[21,30,"RFAL"];case"SHIP":return[125,26,"SHIP"];case"RFAL":return[23,33,"RFAL"];case"VULC":return[36,33,"VULC"];case"B190":return[27,28,"B190"];case"C182":return[26,20,"C182"];case"DHC2":return[35,22,"DHC2"];case"DR40":return[28,22,"DR40"];case"F14":return[34,33,"F14"];case"F28":return[30,34,"F28"];case"J328":return[31,31,"J328"];case"P212":return[27,21,"P212"];case"PC6T":return[29,20,"PC6T"];case"T134":return[29,37,"T134"];case"T144":return[29,66,"T144"];case"TEX2":return[24,23,"TEX2"];default:return[40,40,"A320"]}}function nl2br(e,t){return(e+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+(t||void 0===t?"<br />":"<br>")+"$2")}function wait(t){return new Promise(e=>setTimeout(e,t))}function fetchRetry(t,a=1e3,r=3,i={}){return fetch(t,i).catch(function(e){if(triesLeft=r-1)return wait(a).then(()=>fetchRetry(t,a,triesLeft,i));throw e})}var green="#13b955",blue="#009cdc",yellow="#efa31d",red="#da292e",gray="#aaaaaa";function getElapsedWidth(e){return 100*(getDfd(e)/getTotalDistance(e)-$("#flights-progressbar-plane").width()/2/$("#flights-progressbar").width())}function getInfoElapsedWidth(e){return(value=getDfd(e)/getTotalDistance(e)*100-6)<0?0:value}function getRhumbLineBearing(e,t,a,r){return dLon=deg2rad(r)-deg2rad(t),dPhi=Math.log(Math.tan(deg2rad(a)/2+Math.PI/4)/Math.tan(deg2rad(e)/2+Math.PI/4)),Math.abs(dLon)>Math.PI&&(dLon=0<dLon?-1*(2*Math.PI-dLon):2*Math.PI+dLon),(rad2deg(Math.atan2(dLon,dPhi))+360)%360}function deg2rad(e){return.017453292519943295*e}function rad2deg(e){return e/.017453292519943295}function getDtg(e){var t=airports[e.arr];return dtg=t?distance(Number(e.lat),Number(e.lon),Number(t.lat),Number(t.lon)):0}function getDfd(e){var t=airports[e.dep];return dtg=t?distance(Number(e.lat),Number(e.lon),Number(t.lat),Number(t.lon)):0}function getStatus(e){return ret={},""==e.dep&&""==e.arr?(ret.status="No Flightplan",ret.color=gray,ret.blink=!1):"Diverted"==e.status?(ret.status="Diverted",ret.color=red,ret.blink=!1):getDfd(e)<40?0==e.gndspd?(ret.status="Pre-Departure",ret.color=blue,ret.blink=!1):(e.gndspd<50?ret.status="Left Gate":ret.status="Departed",ret.color=blue,ret.blink=!0):getDtg(e)<40?0==e.gndspd?(ret.status="Arrived",ret.color=green,ret.blink=!1):e.gndspd<50?(ret.status="Landed",ret.color=yellow,ret.blink=!1):(ret.status="Arriving Shortly",ret.color=yellow,ret.blink=!0):(ret.status="Enroute",ret.color=green,ret.blink=!1),ret}function getTotalDistance(e){return arr=airports[e.arr],dep=airports[e.dep],dtg=dep&&arr?distance(Number(e.lat),Number(e.lon),Number(arr.lat),Number(arr.lon))+distance(Number(e.lat),Number(e.lon),Number(dep.lat),Number(dep.lon)):50}function getTimeAirborne(e){var t,a=void 0!==e.updated_at?moment(e.updated_at+"+0000"):moment(),r=e.departed_at?moment(e.departed_at+"+0000"):null,e=e.arrived_at?moment(e.arrived_at+"+0000"):null;return a=null!=r&&null==e?(t=Math.abs(a.diff(r,"minutes")),"airborne"):null!=r&&null!=e?(t=Math.abs(e.diff(r,"minutes")),"landed"):(t=null,"nodep"),null!=t?{status:a,timeonline:[Math.floor(t/60),t%60]}:{status:a}}function distance(e,t,i,s){return r=3440.1,e=deg2rad(e),t=deg2rad(t),i=deg2rad(i),s=deg2rad(s),lonDelta=s-t,a=Math.pow(Math.cos(i)*Math.sin(lonDelta),2)+Math.pow(Math.cos(e)*Math.sin(i)-Math.sin(e)*Math.cos(i)*Math.cos(lonDelta),2),b=Math.sin(e)*Math.sin(i)+Math.cos(e)*Math.cos(i)*Math.cos(lonDelta),(angle=Math.atan2(Math.sqrt(a),b))*r}function runSearch(i,s=null){var o={flights:[],airports:[]};return $.each(flights,(e,t)=>{var a,r;a=("al"==s?(console.log(t.callsign),null!==a&&null!==(a=t.callsign.match(/[A-Z]+/))&&a.length?a[0]:t.callsign):t.aircraft+"|"+t.arr+"|"+t.callsign+"|"+t.dep+"|"+t.cid+"|"+t.route).toLowerCase(),"al"==s?a==i&&(r=getStatus(t),o.flights.push({callsign:t.callsign,aircraft:t.aircraft,arr:t.arr,dep:t.dep,route:t.route,uid:t.uid,status:r})):a.includes(i)&&(r=getStatus(t),o.flights.push({callsign:t.callsign,aircraft:t.aircraft,arr:t.arr,dep:t.dep,route:t.route,uid:t.uid,status:r}))}),2<i.length&&$.each(airports,(e,t)=>{(t.icao+"|"+t.name+"|").toLowerCase().includes(i)&&o.airports.push({icao:t.icao,name:t.name,iata:t.iata,city:t.city})}),o}function compileSearchResults(e){var[e,t]=parseSearch(e),a=runSearch(t,e);if(!t.length)return'<tr><td class="px-3 text-muted" colspan="2">Begin typing to search.<br><br><small style="color: #aaa">Helpers:</small></td></tr><tr><td class="px-3 small text-muted">ap:</td><td class="px-3 small text-muted">Airport search</td></tr><tr><td class="px-3 small text-muted">al:</td><td class="px-3 small text-muted">Airline search</td></tr><tr><td class="px-3 small text-muted">flight:</td><td class="px-3 small text-muted">Callsign search</td></tr>';var r=Handlebars.compile('<tr><td class="px-3" style="position: relative"><div style="position: absolute; top: 50%; left: 8; right: 8; height: 2; background-color: #ddd; z-index: -1"></div><small style="color: #bbb" class=" bg-white px-1">Flights ({{ results.length }})</small></td></tr>{{#if results.length}}{{#each results}}<tr class="search-item" onClick="zoomToFlight(\'{{ this.uid }}\')"><td class="px-3"><p class="mb-0">{{ this.callsign }}</p><small style="font-size: 0.8rem">{{ this.cid }} {{#if this.dep }}{{ this.dep }} - {{ this.arr }} - {{ this.aircraft }} - <span style="color: {{ this.status.color }}">{{ this.status.status }}</span></small>{{ else }} No flightplan {{/if}}</td></tr>{{/each}}{{else}}<tr><td class="px-3 text-muted">No results.</td></tr>{{/if}}'),i=Handlebars.compile('<tr><td class="px-3" style="position: relative"><div style="position: absolute; top: 50%; left: 8; right: 8; height: 2; background-color: #ddd; z-index: -1"></div><small class="px-1 bg-white" style="color: #bbb">Airports ({{ results.length }})</small></td></tr>{{#if trigger}}{{#if results.length}}{{#each results}}<tr class="search-item" icao="{{ this.icao }}" onclick="zoomToAirport(\'{{ this.icao }}\')"><td class="px-3"><p class="mb-0">{{ this.icao }} / {{ this.iata }}<br><small class="text-muted">{{ this.name }}</small></p></td></tr>{{/each}}{{else}}<tr><td class="px-3 text-muted">No results.</td></tr>{{/if}}{{else}}<tr><td class="px-3 text-muted">At least 3 characters required.</td></tr>{{/if}}'),s=r({results:a.flights}),o=i({results:a.airports,trigger:2<t.length});switch(e){case null:return o+s;case"flight":case"al":case"ac":return s;case"ap":return o}}function parseSearch(e){var t,e=e.split(":");return e=1==e.length?(t=null,e[0]):(t=e[0],e[1]),[t,e]}function searchAction(){var e=$("#search-field").val().toLowerCase();e.length?($("#search-results").html(compileSearchResults(e)),$("#search-wrapper").show()):($("#search-results").html(""),$("#search-wrapper").hide())}async function initializeUser(e){el=document.getElementById("user-sidebar"),L.DomEvent.disableScrollPropagation(el),L.DomEvent.disableClickPropagation(el),$("#flight-list").html('<div class="p-3 d-flex" style="justify-content: center; align-items: center"><div class="spinner-border text-secondary" role="status"></div> <h5 class="ms-4 mb-0 text-secondary">Loading...</h5></div>');var t=await fetchRetry("https://api.simaware.ca/api/user/"+e);user=await t.json(),$("#pilot-name").html(user.name);e=await(t=await fetchRetry("https://api.simaware.ca/api/moreflights/"+e+"/0")).json();html="",$.each(e,(e,t)=>{html+='<tr uid="'+t.uid+'" onclick="zoomToFlight(\''+t.uid+'\')" class="flight"><td style="font-size: 1rem; text-align: center" class="py-2 px-1">',void 0!==plane_array[t.uid]?html+='<span class="live text-white px-2">Live</span>':html+=t.date,html+='</td><td class="p-2 ps-0">'+t.callsign+"<br><small>"+t.dep+" ("+t.depicao+")<br>"+t.arr+" ("+t.arricao+")</small></td></tr>"}),$("#flight-list").html(html)}async function zoomToUser(e){$("#map").length&&!manual||(window.location.href="/?user="+e),"undefined"!=typeof ap_featuregroup&&returnFromAirport(),$("#user-sidebar").show(),$("#search-wrapper").hide(),user_sidebar=!0,await initializeUser(e),window.history.pushState(e,e,"/?user="+e)}$(document).ready(()=>{$("#search-field").on("input",()=>{searchAction()})});
